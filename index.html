<!doctype html>
<!--
    Revenue Dashboard v2 - Modern Dark Theme

    FEATURES:
    - Modern dark theme with clean design
    - Mobile-first responsive layout (5 breakpoints)
    - Touch-optimized mobile interface
    - Mobile menu button for tabs on smaller screens
    - GitHub auto-load functionality
    - Excel file upload/drag-and-drop
    - Interactive charts with Chart.js
    - Global metrics dashboard
    - Smart chart grid layouts

    SETUP INSTRUCTIONS:
    1. Create a GitHub repository for your revenue dashboard
    2. Upload this index2.html file to the repo
    3. Upload your revenue_analysis_current.xlsx file to the repo
    4. Enable GitHub Pages in repository settings (Settings > Pages > Source: main branch)
    5. Update the EXCEL_FILE_URL constant in this file (line ~740) with your GitHub raw file URL
       Format: https://raw.githubusercontent.com/YOUR_USERNAME/YOUR_REPO/main/revenue_analysis_current.xlsx
    6. Every time you run your analysis script, commit and push the new Excel file to GitHub
    7. The dashboard will automatically fetch and display the latest data when loaded

    Your dashboard URL will be: https://YOUR_USERNAME.github.io/YOUR_REPO/

    LOCAL TESTING:
    - For local testing, run a simple HTTP server in this directory:
      - Python 3: python -m http.server 8000
      - Node.js: npx serve .
      - PHP: php -S localhost:8000
    - Then open http://localhost:8000/index2.html in your browser
    - The default EXCEL_FILE_URL points to 'revenue_analysis_current.xlsx' in the same directory

    MOBILE MENU:
    - On screens 991px and below, a "Tabs" menu button appears in the header
    - Click the button to show/hide the sheet tabs
    - Tabs are displayed as a vertical dropdown list on mobile
    - Menu automatically closes when selecting a tab or clicking outside
-->
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="color-scheme" content="light only" />
        <title>Revenue Dashboard</title>

        <!-- SheetJS -->
        <script src="https://cdn.sheetjs.com/xlsx-0.18.5/package/dist/xlsx.full.min.js"></script>

        <!-- Chart.js -->
        <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.js"></script>

        <!-- Inter font -->
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
            rel="stylesheet"
        />

        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }
            
            /* Force light theme - override system dark mode */
            html {
                color-scheme: light only;
            }
            
            /* Prevent dark mode from affecting any elements */
            * {
                color-scheme: light only;
            }

            :root {
                color-scheme: light only;
                --bg: #ffffff;
                --bg-secondary: #fafafa;
                --card-bg: #ffffff;
                --border: #e5e7eb;
                --border-hover: #d1d5db;
                --text: #111827;
                --text-secondary: #6b7280;
                --text-muted: #9ca3af;
                --accent: #000000;
                --accent-light: #f9fafb;
                --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
                --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
                --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
                --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            }

            body {
                font-family: "Inter", sans-serif;
                background: var(--bg-secondary) !important;
                color: var(--text) !important;
                line-height: 1.6;
                -webkit-font-smoothing: antialiased;
                -moz-osx-font-smoothing: grayscale;
                color-scheme: light only;
            }
            
            /* Override any dark mode attempts */
            @media (prefers-color-scheme: dark) {
                :root {
                    color-scheme: light only;
                }
                
                body {
                    background: #fafafa !important;
                    color: #111827 !important;
                }
            }

            .container {
                max-width: 1400px;
                margin: 0 auto;
                padding: 40px 24px;
            }

            /* Header */
            .header {
                margin-bottom: 48px;
            }

            .header-top {
                display: flex;
                justify-content: space-between;
                align-items: center;
                gap: 24px;
            }

            .header-title {
                flex: 1;
            }

            .header h1 {
                font-size: 32px;
                font-weight: 800;
                color: var(--accent);
                margin-bottom: 0;
                letter-spacing: -0.02em;
            }

            .header p {
                font-size: 15px;
                color: var(--text-secondary);
                font-weight: 500;
            }

            /* Mobile Menu Button */
            .mobile-menu-btn {
                display: none;
                background: var(--accent);
                border: none;
                border-radius: 12px;
                color: white;
                padding: 12px 20px;
                font-size: 14px;
                font-weight: 600;
                cursor: pointer;
                touch-action: manipulation;
                -webkit-tap-highlight-color: rgba(0, 0, 0, 0.1);
                user-select: none;
                min-height: 44px;
                align-items: center;
                gap: 8px;
                transition: all 0.2s;
                box-shadow: var(--shadow);
            }

            .mobile-menu-btn:hover {
                background: #1f2937;
                box-shadow: var(--shadow-md);
            }

            .mobile-menu-btn.active {
                background: var(--accent);
                box-shadow: var(--shadow-md);
            }

            .menu-icon {
                display: inline-block;
                width: 18px;
                height: 2px;
                background: white;
                position: relative;
            }

            .menu-icon::before,
            .menu-icon::after {
                content: "";
                position: absolute;
                width: 18px;
                height: 2px;
                background: white;
                left: 0;
            }

            .menu-icon::before {
                top: -6px;
            }

            .menu-icon::after {
                bottom: -6px;
            }

            .mobile-menu-btn.active .menu-icon {
                background: transparent;
            }

            .mobile-menu-btn.active .menu-icon::before {
                transform: rotate(45deg);
                top: 0;
            }

            .mobile-menu-btn.active .menu-icon::after {
                transform: rotate(-45deg);
                bottom: 0;
            }

            /* Upload */
            .upload-section {
                background: var(--card-bg);
                border: 2px dashed var(--border);
                border-radius: 20px;
                padding: 64px 48px;
                text-align: center;
                cursor: pointer;
                transition: all 0.2s ease;
                touch-action: manipulation;
                -webkit-tap-highlight-color: rgba(0, 0, 0, 0.05);
                user-select: none;
                box-shadow: var(--shadow-sm);
            }

            .upload-section:hover {
                border-color: var(--accent);
                box-shadow: var(--shadow-md);
                background: var(--accent-light);
            }

            .upload-section h2 {
                font-size: 20px;
                font-weight: 700;
                margin-bottom: 10px;
                color: var(--accent);
                letter-spacing: -0.01em;
            }

            .upload-section p {
                color: var(--text-secondary);
                margin-bottom: 24px;
                font-size: 15px;
                font-weight: 500;
            }

            .btn-upload {
                background: var(--accent);
                color: white;
                border: none;
                padding: 14px 32px;
                border-radius: 12px;
                font-size: 15px;
                font-weight: 600;
                cursor: pointer;
                touch-action: manipulation;
                -webkit-tap-highlight-color: rgba(0, 0, 0, 0.1);
                user-select: none;
                transition: all 0.15s ease;
                box-shadow: var(--shadow-md);
            }
            
            .btn-upload:hover {
                background: #1f2937;
                transform: translateY(-2px);
                box-shadow: var(--shadow-lg);
            }

            #fileInput {
                display: none;
            }

            /* Loading */
            .loading {
                text-align: center;
                padding: 60px;
                display: none;
            }

            .loading.active {
                display: block;
            }

            .spinner {
                width: 48px;
                height: 48px;
                margin: 0 auto 20px;
                border: 4px solid var(--border);
                border-top: 4px solid var(--accent);
                border-radius: 50%;
                animation: spin 1s linear infinite;
            }
            
            .loading h2 {
                color: var(--accent);
                font-weight: 700;
            }

            @keyframes spin {
                0% {
                    transform: rotate(0deg);
                }
                100% {
                    transform: rotate(360deg);
                }
            }

            /* Dashboard */
            .dashboard {
                display: none;
            }

            .dashboard.active {
                display: block;
            }

            /* GLOBAL METRICS - ABOVE TABS */
            .global-metrics {
                display: grid;
                grid-template-columns: repeat(4, 1fr);
                gap: 20px;
                margin-bottom: 40px;
            }
            
            @media (max-width: 1200px) {
                .global-metrics {
                    grid-template-columns: repeat(3, 1fr) !important;
                    gap: 16px;
                }
            }
            
            @media (max-width: 991px) {
                .global-metrics {
                    grid-template-columns: repeat(2, 1fr) !important;
                    gap: 12px;
                }
            }
            
            @media (max-width: 400px) {
                .global-metrics {
                    grid-template-columns: repeat(2, 1fr) !important;
                    gap: 10px;
                }
            }

            /* Tabs - NO SCROLL, wrap to multiple lines */
            .tabs {
                display: flex;
                gap: 10px;
                margin-bottom: 32px;
                flex-wrap: wrap;
            }

            .tab {
                background: var(--card-bg);
                border: 1.5px solid var(--border);
                padding: 12px 24px;
                border-radius: 12px;
                cursor: pointer;
                transition: all 0.15s ease;
                font-size: 14px;
                font-weight: 600;
                white-space: nowrap;
                touch-action: manipulation;
                -webkit-tap-highlight-color: rgba(0, 0, 0, 0.05);
                user-select: none;
                color: var(--text-secondary);
                box-shadow: var(--shadow-sm);
            }

            .tab:hover {
                border-color: var(--accent);
                color: var(--accent);
                box-shadow: var(--shadow);
                transform: translateY(-1px);
            }

            .tab.active {
                background: var(--accent);
                border-color: var(--accent);
                color: white;
                box-shadow: var(--shadow-md);
            }

            /* Mobile tabs state */
            .tabs.tabs-mobile-hidden {
                display: none !important;
            }

            .tabs.tabs-mobile-visible {
                display: block !important;
                position: fixed !important;
                z-index: 10000 !important;
                background: var(--card-bg) !important;
                border: 1px solid var(--border) !important;
                border-radius: 16px !important;
                padding: 16px !important;
                max-height: 80vh !important;
                height: auto !important;
                overflow-y: scroll !important;
                overflow-x: hidden !important;
                -webkit-overflow-scrolling: touch !important;
                box-shadow: var(--shadow-lg) !important;
                min-width: 250px !important;
                max-width: calc(100vw - 40px) !important;
            }
            
            .tabs.tabs-mobile-visible .tab {
                display: block !important;
                width: 100% !important;
                margin-bottom: 10px !important;
                text-align: left !important;
                padding: 14px 20px !important;
                white-space: normal !important;
            }
            
            /* Make scrollbar visible on mobile dropdown */
            .tabs.tabs-mobile-visible::-webkit-scrollbar {
                width: 6px;
            }
            
            .tabs.tabs-mobile-visible::-webkit-scrollbar-track {
                background: var(--bg-secondary);
                border-radius: 3px;
            }
            
            .tabs.tabs-mobile-visible::-webkit-scrollbar-thumb {
                background: var(--accent);
                border-radius: 3px;
            }
            
            .tabs.tabs-mobile-visible::-webkit-scrollbar-thumb:hover {
                background: #374151;
            }

            /* Desktop tabs - always visible */
            .tabs.tabs-desktop-visible {
                display: flex !important;
            }

            /* Tab content */
            .tab-content {
                display: none;
            }

            .tab-content.active {
                display: block;
            }

            /* Key metrics cards at top */
            .metrics-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 16px;
                margin-bottom: 24px;
            }

            .metric-card {
                background: var(--card-bg);
                border: 1px solid var(--border);
                border-radius: 16px;
                padding: 28px;
                transition: all 0.2s ease;
                box-shadow: var(--shadow-sm);
            }
            
            .metric-card:hover {
                box-shadow: var(--shadow-md);
                border-color: var(--border-hover);
            }

            .metric-label {
                font-size: 13px;
                font-weight: 600;
                color: var(--text-secondary);
                text-transform: uppercase;
                letter-spacing: 0.8px;
                margin-bottom: 12px;
            }

            .metric-value {
                font-size: 32px;
                font-weight: 800;
                color: var(--accent);
                letter-spacing: -0.02em;
            }
            
            .metric-subtext {
                font-size: 12px;
                color: var(--text-muted);
                margin-top: 8px;
                font-weight: 500;
            }
            
            .metric-trend {
                display: inline-block;
                font-size: 12px;
                font-weight: 600;
                padding: 4px 8px;
                border-radius: 6px;
                margin-top: 8px;
            }
            
            .metric-trend.positive {
                background: #d1fae5;
                color: #065f46;
            }
            
            .metric-trend.negative {
                background: #fee2e2;
                color: #991b1b;
            }
            
            @media (max-width: 767px) {
                .metric-card {
                    padding: 20px 16px;
                    border-radius: 12px;
                }
                
                .metric-label {
                    font-size: 10px;
                    margin-bottom: 8px;
                    letter-spacing: 0.5px;
                }
                
                .metric-value {
                    font-size: 24px;
                }
                
                .metric-subtext {
                    font-size: 10px;
                    margin-top: 4px;
                }
                
                .metric-trend {
                    font-size: 10px;
                    padding: 3px 6px;
                }
            }

            /* Charts - smart grid layout */
            .charts-grid {
                display: grid;
                gap: 20px;
                margin-bottom: 24px;
            }

            /* 1 chart = full width */
            .charts-grid.cols-1 {
                grid-template-columns: 1fr;
            }

            /* 2 charts = 50/50 */
            .charts-grid.cols-2 {
                grid-template-columns: repeat(2, 1fr);
            }

            /* 3 charts = 1 full width, 2 half */
            .charts-grid.cols-3 {
                grid-template-columns: repeat(2, 1fr);
            }

            .charts-grid.cols-3 .chart-card:first-child {
                grid-column: 1 / -1;
            }

            /* 4 charts = 2x2 grid */
            .charts-grid.cols-4 {
                grid-template-columns: repeat(2, 1fr);
            }

            /* 5 charts = 1 full, 2 half, 2 half */
            .charts-grid.cols-5 {
                grid-template-columns: repeat(2, 1fr);
            }

            .charts-grid.cols-5 .chart-card:first-child {
                grid-column: 1 / -1;
            }

            .chart-card {
                background: var(--card-bg);
                border: 1px solid var(--border);
                border-radius: 16px;
                padding: 28px;
                transition: all 0.2s ease;
                box-shadow: var(--shadow-sm);
            }
            
            .chart-card:hover {
                box-shadow: var(--shadow-md);
                border-color: var(--border-hover);
            }

            .chart-title {
                font-size: 18px;
                font-weight: 700;
                margin-bottom: 6px;
                color: var(--accent);
                letter-spacing: -0.01em;
            }

            .chart-subtitle {
                font-size: 14px;
                color: var(--text-secondary);
                margin-bottom: 24px;
                font-weight: 500;
            }

            .chart-container {
                position: relative;
                height: 300px;
            }

            .chart-container.tall {
                height: 400px;
            }

            /* Table - scrollable container */
            .table-section {
                background: var(--card-bg);
                border: 1px solid var(--border);
                border-radius: 16px;
                padding: 28px;
                box-shadow: var(--shadow-sm);
                transition: all 0.2s ease;
            }
            
            .table-section:hover {
                box-shadow: var(--shadow-md);
                border-color: var(--border-hover);
            }

            .table-header {
                margin-bottom: 20px;
            }

            .table-title {
                font-size: 18px;
                font-weight: 700;
                margin-bottom: 6px;
                color: var(--accent);
                letter-spacing: -0.01em;
            }

            .table-subtitle {
                font-size: 14px;
                color: var(--text-secondary);
                font-weight: 500;
            }

            .search-box {
                width: 100%;
                max-width: 420px;
                background: var(--bg-secondary);
                border: 1.5px solid var(--border);
                border-radius: 12px;
                padding: 12px 16px;
                color: var(--text);
                font-size: 14px;
                margin-bottom: 20px;
                transition: all 0.15s ease;
                font-weight: 500;
            }

            .search-box:focus {
                outline: none;
                border-color: var(--accent);
                background: var(--card-bg);
                box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.05);
            }
            
            .search-box::placeholder {
                color: var(--text-muted);
            }

            /* SCROLLABLE TABLE CONTAINER */
            .table-wrapper {
                max-height: 600px;
                overflow: auto;
                border: 1px solid var(--border);
                border-radius: 12px;
            }

            table {
                width: 100%;
                border-collapse: collapse;
                font-size: 14px;
            }

            thead {
                position: sticky;
                top: 0;
                background: var(--bg-secondary);
                z-index: 10;
            }

            th {
                padding: 12px 16px;
                text-align: left;
                font-weight: 700;
                color: var(--accent);
                border-bottom: 2px solid var(--border);
                white-space: nowrap;
                position: relative;
                vertical-align: top;
                background: var(--bg-secondary);
            }
            
            th .header-content {
                display: flex;
                flex-direction: column;
                gap: 4px;
            }
            
            th .column-name {
                font-weight: 700;
                font-size: 12px;
                cursor: pointer;
                user-select: none;
                padding: 6px 0;
                color: var(--accent);
                text-transform: uppercase;
                letter-spacing: 0.5px;
                transition: all 0.15s ease;
            }
            
            th .column-name:hover {
                color: #374151;
            }
            
            th .column-name.sort-asc::after {
                content: " ▲";
                font-size: 9px;
                color: var(--accent);
            }
            
            th .column-name.sort-desc::after {
                content: " ▼";
                font-size: 9px;
                color: var(--accent);
            }
            
            th input.column-filter {
                width: 100%;
                background: var(--card-bg);
                border: 1.5px solid var(--border);
                border-radius: 8px;
                padding: 6px 10px;
                color: var(--text);
                font-size: 12px;
                font-family: inherit;
                font-weight: 500;
                transition: all 0.15s ease;
            }
            
            th input.column-filter:focus {
                outline: none;
                border-color: var(--accent);
                box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.05);
            }
            
            th input.column-filter::placeholder {
                color: var(--text-muted);
                font-size: 11px;
            }

            td {
                padding: 14px 16px;
                border-bottom: 1px solid var(--border);
                color: var(--text-secondary);
                font-weight: 500;
            }

            tbody tr {
                transition: all 0.15s ease;
            }

            tbody tr:hover {
                background: var(--accent-light);
            }

            /* Responsive - Mobile First Approach */

            /* Base mobile styles (applies to all screens) */
            .container {
                padding: 16px;
            }

            /* Small tablets and large phones (768px and up) */
            @media (min-width: 768px) {
                .container {
                    padding: 20px;
                }
            }

            /* Large tablets and small desktops (992px and up) */
            @media (min-width: 992px) {
                .container {
                    padding: 24px;
                }
            }

            /* Desktop (1200px and up) */
            @media (min-width: 1200px) {
                .container {
                    padding: 24px;
                }
            }

            /* Mobile-specific adjustments */
            @media (max-width: 1199px) {
                /* Tablet and below */
            }

            @media (max-width: 991px) {
                /* Small tablet and large phone */
                .charts-grid.cols-2,
                .charts-grid.cols-3,
                .charts-grid.cols-4,
                .charts-grid.cols-5 {
                    grid-template-columns: 1fr !important;
                }

                .charts-grid .chart-card {
                    grid-column: 1 !important;
                }

                /* Show mobile menu button on mobile screens */
                .mobile-menu-btn {
                    display: flex;
                }

                /* Hide download button on mobile to save space */
                #downloadBtn {
                    display: none !important;
                }

                /* Tabs mobile - REMOVE THIS ENTIRE SECTION - handled by main CSS */

                .tabs.tabs-mobile-visible .tab {
                    width: 100%;
                    text-align: left;
                    padding: 12px 16px;
                    min-height: 44px;
                    white-space: normal;
                    line-height: 1.4;
                    flex-shrink: 0;
                    touch-action: manipulation;
                }

                .metric-value {
                    font-size: 24px;
                }
            }

            @media (max-width: 767px) {
                /* Phones and small tablets */
                .header h1 {
                    font-size: 24px;
                }

                .header p {
                    font-size: 13px;
                }

                /* Mobile menu button visible on mobile screens */
                .mobile-menu-btn {
                    display: flex;
                }

                /* Tabs mobile - REMOVE THIS ENTIRE SECTION - handled by main CSS */

                .upload-section {
                    padding: 32px 20px;
                }

                .upload-section h2 {
                    font-size: 16px;
                }

                .upload-section p {
                    font-size: 14px;
                }

                .btn-upload {
                    padding: 12px 24px;
                    font-size: 15px;
                    min-height: 48px;
                    min-width: 140px;
                }

                .metrics-grid {
                    grid-template-columns: 1fr;
                    gap: 12px;
                }

                .metric-card {
                    padding: 16px;
                }

                .metric-label {
                    font-size: 11px;
                }

                .metric-value {
                    font-size: 22px;
                }

                /* Tabs handled by mobile menu - see styles above */

                .chart-card {
                    padding: 16px;
                }

                .chart-title {
                    font-size: 15px;
                }

                .chart-subtitle {
                    font-size: 12px;
                }

                .chart-container {
                    height: 250px;
                }

                .chart-container.tall {
                    height: 320px;
                }

                .table-section {
                    padding: 16px;
                }

                .table-title {
                    font-size: 15px;
                }

                .table-subtitle {
                    font-size: 12px;
                }

                .search-box {
                    padding: 12px 14px;
                    font-size: 16px; /* Prevent iOS zoom */
                    max-width: 100%;
                }

                .table-wrapper {
                    max-height: 400px;
                }

                table {
                    font-size: 12px;
                }

                th,
                td {
                    padding: 8px 12px;
                }

                .loading {
                    padding: 40px 20px;
                }

                .loading h2 {
                    font-size: 16px;
                }
            }

            @media (max-width: 575px) {
                /* Small phones */
                .header h1 {
                    font-size: 22px;
                }

                .header {
                    margin-bottom: 24px;
                }

                .upload-section {
                    padding: 24px 16px;
                }

                .tab {
                    flex: 1 0 100%;
                    max-width: 100%;
                    font-size: 13px;
                    padding: 12px 16px;
                }

                .chart-container {
                    height: 220px;
                }

                .chart-container.tall {
                    height: 280px;
                }

                .table-wrapper {
                    max-height: 350px;
                }

                th,
                td {
                    padding: 6px 10px;
                }

                .search-box {
                    font-size: 16px; /* Prevent iOS zoom */
                    padding: 10px 12px;
                    max-width: 100%;
                }
            }

            @media (max-width: 399px) {
                /* Very small phones */
                .container {
                    padding: 12px;
                }

                .header h1 {
                    font-size: 20px;
                }

                .metric-value {
                    font-size: 20px;
                }

                .chart-container {
                    height: 200px;
                }

                .chart-container.tall {
                    height: 250px;
                }

                .table-wrapper {
                    max-height: 300px;
                }
            }

            /* Special handling for very wide tables on mobile */
            @media (max-width: 767px) {
                .table-wrapper {
                    overflow-x: auto;
                    -webkit-overflow-scrolling: touch;
                }

                table {
                    min-width: 600px; /* Ensures table doesn't collapse too much */
                }

                th,
                td {
                    white-space: nowrap;
                }
            }

            /* Print styles */
            @media print {
                .upload-section,
                .tabs,
                .search-box,
                .btn-upload {
                    display: none !important;
                }

                .dashboard.active {
                    display: block !important;
                }

                .tab-content.active {
                    display: block !important;
                }

                .table-wrapper {
                    max-height: none;
                    overflow: visible;
                }

                table {
                    border-collapse: collapse;
                }

                th,
                td {
                    border: 1px solid #ddd;
                }
            }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="header">
                <div class="header-top">
                    <div class="header-title">
                        <h1>Revenue Dashboard</h1>
                        <p>Data analytics and insights</p>
                    </div>
                    <button
                        class="mobile-menu-btn"
                        id="mobileMenuBtn"
                        aria-label="Toggle tabs menu"
                        aria-expanded="false"
                    >
                        <span class="menu-icon"></span>
                        <span class="menu-text">Tabs</span>
                    </button>
                    <button
                        id="downloadBtn"
                        style="display: none; background: var(--accent); color: white; border: none; padding: 12px; border-radius: 12px; cursor: pointer; margin-left: 12px; touch-action: manipulation; -webkit-tap-highlight-color: rgba(0, 0, 0, 0.1); user-select: none; transition: all 0.2s; display: flex; align-items: center; justify-content: center;"
                        aria-label="Download original Excel file"
                    >
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 10V16M12 16L9 13M12 16L15 13M17 21H7C5.89543 21 5 20.1046 5 19V5C5 3.89543 5.89543 3 7 3H14L19 8V19C19 20.1046 18.1046 21 17 21Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Upload -->
            <div class="upload-section" id="uploadSection">
                <h2>Upload Excel File</h2>
                <p>Drop file here or click to browse</p>
                <button
                    class="btn-upload"
                    onclick="document.getElementById('fileInput').click()"
                >
                    Choose File
                </button>
                <input type="file" id="fileInput" accept=".xlsx,.xls" />
            </div>

            <!-- Loading -->
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <h2>Processing data...</h2>
            </div>

            <!-- Dashboard -->
            <div class="dashboard" id="dashboard">
                <!-- GLOBAL METRICS - ALWAYS VISIBLE -->
                <div class="global-metrics">
                    <div class="metric-card">
                        <div class="metric-label">Total Revenue</div>
                        <div class="metric-value" id="global-revenue">-</div>
                        <div class="metric-subtext" id="global-revenue-sub">All time</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">This Month</div>
                        <div class="metric-value" id="global-current-month">-</div>
                        <div class="metric-trend" id="global-month-trend"></div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Total Clients</div>
                        <div class="metric-value" id="global-clients">-</div>
                        <div class="metric-subtext" id="global-clients-sub">Unique customers</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Total Services</div>
                        <div class="metric-value" id="global-services">-</div>
                        <div class="metric-subtext" id="global-services-sub">All bookings</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Avg per Client</div>
                        <div class="metric-value" id="global-avg">-</div>
                        <div class="metric-subtext">Lifetime value</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Best Month</div>
                        <div class="metric-value" id="global-best-month">-</div>
                        <div class="metric-subtext" id="global-best-month-name">-</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Avg Monthly</div>
                        <div class="metric-value" id="global-avg-monthly">-</div>
                        <div class="metric-subtext" id="global-months-count">Last 12 months</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Next Month</div>
                        <div class="metric-value" id="global-forecast">-</div>
                        <div class="metric-subtext">Forecast (moderate)</div>
                    </div>
                </div>

                <div class="tabs" id="tabs"></div>
                <div id="tabsContent"></div>
            </div>
        </div>

        <script>
            let workbookData = {};
            let charts = {};
            let globalMetrics = {};
            
            // Configure Chart.js for better mobile experience
            if (typeof Chart !== 'undefined') {
                Chart.defaults.font.family = "'Inter', sans-serif";
                Chart.defaults.color = '#6b7280';
                Chart.defaults.borderColor = 'rgba(0, 0, 0, 0.08)';
            }

            // Configuration: Update this URL to your GitHub raw file URL
            // For local development: 'revenue_analysis_current.xlsx'
            // For GitHub Pages: 'https://raw.githubusercontent.com/YOUR_USERNAME/YOUR_REPO/main/revenue_analysis_current.xlsx'
            const EXCEL_FILE_URL = "revenue_analysis_current.xlsx";

            const fileInput = document.getElementById("fileInput");
            const uploadSection = document.getElementById("uploadSection");

            fileInput.addEventListener("change", handleFile);

            uploadSection.addEventListener("dragover", (e) => {
                e.preventDefault();
            });

            uploadSection.addEventListener("drop", (e) => {
                e.preventDefault();
                const file = e.dataTransfer.files[0];
                if (file) processFile(file);
            });

            uploadSection.addEventListener("click", (e) => {
                if (e.target.tagName !== "BUTTON") {
                    fileInput.click();
                }
            });

            // Mobile menu button functionality
            const mobileMenuBtn = document.getElementById("mobileMenuBtn");
            const tabsContainer = document.getElementById("tabs");

            function updateTabsForScreenSize() {
                if (!tabsContainer) return;

                const isMobile =
                    window.matchMedia("(max-width: 991px)").matches;

                if (isMobile) {
                    // On mobile: ensure tabs are hidden by default unless menu is active
                    if (
                        !tabsContainer.classList.contains("tabs-mobile-visible")
                    ) {
                        tabsContainer.classList.add("tabs-mobile-hidden");
                        tabsContainer.classList.remove("tabs-desktop-visible");
                    }
                } else {
                    // On desktop: show tabs normally, remove mobile classes
                    tabsContainer.classList.remove(
                        "tabs-mobile-hidden",
                        "tabs-mobile-visible",
                    );
                    tabsContainer.classList.add("tabs-desktop-visible");
                    // Reset inline styles
                    tabsContainer.style.position = "";
                    tabsContainer.style.margin = "";
                    tabsContainer.style.top = "";
                    tabsContainer.style.left = "";
                    tabsContainer.style.width = "";
                    tabsContainer.style.maxHeight = "";
                    tabsContainer.style.zIndex = "";
                    if (mobileMenuBtn) {
                        mobileMenuBtn.classList.remove("active");
                        mobileMenuBtn.setAttribute("aria-expanded", "false");
                    }
                }
            }

            function positionMobileTabsDropdown() {
                if (!mobileMenuBtn || !tabsContainer) return;

                const isMobile =
                    window.matchMedia("(max-width: 991px)").matches;
                if (!isMobile) return;

                if (tabsContainer.classList.contains("tabs-mobile-visible")) {
                    const btnRect = mobileMenuBtn.getBoundingClientRect();
                    const viewportHeight = window.innerHeight;
                    const viewportWidth = window.innerWidth;

                    // Simple positioning - let CSS handle everything else
                    const top = btnRect.bottom + 8;
                    const left = 20;
                    const width = viewportWidth - 40;
                    
                    tabsContainer.style.top = top + "px";
                    tabsContainer.style.left = left + "px";  
                    tabsContainer.style.right = "20px";
                    
                    console.log("Dropdown opened");
                }
            }

            if (mobileMenuBtn && tabsContainer) {
                // Initial setup - hide button until data is loaded
                mobileMenuBtn.style.display = "none";
                updateTabsForScreenSize();

                // Update on resize
                window.addEventListener("resize", updateTabsForScreenSize);

                mobileMenuBtn.addEventListener("click", (e) => {
                    e.stopPropagation();
                    const isVisible = tabsContainer.classList.contains(
                        "tabs-mobile-visible",
                    );

                    if (isVisible) {
                        // Hide tabs
                        tabsContainer.classList.remove("tabs-mobile-visible");
                        tabsContainer.classList.add("tabs-mobile-hidden");
                        mobileMenuBtn.classList.remove("active");
                        mobileMenuBtn.setAttribute("aria-expanded", "false");
                        // Clear all inline styles
                        tabsContainer.removeAttribute("style");
                    } else {
                        // Show tabs
                        tabsContainer.classList.remove("tabs-mobile-hidden");
                        tabsContainer.classList.add("tabs-mobile-visible");
                        mobileMenuBtn.classList.add("active");
                        mobileMenuBtn.setAttribute("aria-expanded", "true");
                        // Position dropdown below button
                        positionMobileTabsDropdown();
                    }
                });

                // Reposition dropdown on resize and scroll when visible
                window.addEventListener("resize", () => {
                    if (
                        tabsContainer.classList.contains("tabs-mobile-visible")
                    ) {
                        positionMobileTabsDropdown();
                    }
                });

                window.addEventListener("scroll", () => {
                    if (
                        tabsContainer.classList.contains("tabs-mobile-visible")
                    ) {
                        positionMobileTabsDropdown();
                    }
                });

                // Close mobile menu when clicking outside
                document.addEventListener("click", (e) => {
                    if (
                        !tabsContainer.contains(e.target) &&
                        !mobileMenuBtn.contains(e.target)
                    ) {
                        tabsContainer.classList.remove("tabs-mobile-visible");
                        tabsContainer.classList.add("tabs-mobile-hidden");
                        mobileMenuBtn.classList.remove("active");
                        mobileMenuBtn.setAttribute("aria-expanded", "false");
                    }
                });

                // Close mobile menu when a tab is clicked
                tabsContainer.addEventListener("click", (e) => {
                    if (e.target.classList.contains("tab")) {
                        // Small delay to allow tab switch to complete
                        setTimeout(() => {
                            tabsContainer.classList.remove(
                                "tabs-mobile-visible",
                            );
                            tabsContainer.classList.add("tabs-mobile-hidden");
                            mobileMenuBtn.classList.remove("active");
                            mobileMenuBtn.setAttribute(
                                "aria-expanded",
                                "false",
                            );
                        }, 300);
                    }
                 });
             }

             // Download button functionality
             document.getElementById('downloadBtn').addEventListener('click', async () => {
                 try {
                     const response = await fetch(EXCEL_FILE_URL);
                     if (!response.ok) {
                         throw new Error(`HTTP error! status: ${response.status}`);
                     }
                     const blob = await response.blob();
                     const url = window.URL.createObjectURL(blob);
                     const a = document.createElement('a');
                     a.href = url;
                     a.download = 'revenue_analysis_current.xlsx';  // Customize filename if needed
                     document.body.appendChild(a);
                     a.click();
                     document.body.removeChild(a);
                     window.URL.revokeObjectURL(url);
                 } catch (error) {
                     alert('Error downloading file: ' + error.message);
                 }
             });

             // Auto-load Excel file from URL on page load
            window.addEventListener("DOMContentLoaded", () => {
                loadExcelFromURL();
            });

            async function loadExcelFromURL() {
                try {
                    // Show loading state
                    document.getElementById("uploadSection").style.display =
                        "none";
                    document.getElementById("loading").classList.add("active");

                    const response = await fetch(EXCEL_FILE_URL);
                    if (!response.ok) {
                        throw new Error(
                            `HTTP error! status: ${response.status}`,
                        );
                    }

                    const data = await response.arrayBuffer();
                    await processExcelData(data);
                } catch (error) {
                    console.error("Error loading Excel file:", error);

                    // Determine error type for user-friendly message
                    let errorDetails;
                    if (error.message.includes("404")) {
                        errorDetails =
                            "File not found (404). Make sure revenue_analysis_current.xlsx is in the same directory or update EXCEL_FILE_URL.";
                    } else if (error.message.includes("Failed to fetch")) {
                        errorDetails =
                            "Network error. Check your internet connection or CORS settings.";
                    } else if (
                        error.message.includes("Unexpected end of JSON")
                    ) {
                        errorDetails =
                            "Invalid file format. The file might be corrupted or not a valid Excel file.";
                    } else {
                        errorDetails = error.message;
                    }

                    // Show error in loading screen
                    const loadingEl = document.getElementById("loading");
                    loadingEl.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <div style="font-size: 48px; color: #ef4444; margin-bottom: 20px;">⚠️</div>
                        <h2 style="color: #ef4444; margin-bottom: 16px;">Failed to load data</h2>
                        <p style="color: #94a3b8; margin-bottom: 8px;"><strong>Error:</strong> ${errorDetails}</p>
                        <p style="color: #94a3b8; font-size: 14px; margin-bottom: 8px;">
                            Attempted to load: <code>${EXCEL_FILE_URL}</code>
                        </p>
                        <p style="color: #94a3b8; font-size: 14px; margin-bottom: 24px;">
                            You can still upload a file manually using the upload area below.
                        </p>
                        <button onclick="location.reload()" style="
                            background: #000000;
                            color: white;
                            border: none;
                            padding: 10px 20px;
                            border-radius: 8px;
                            cursor: pointer;
                            font-weight: 600;
                        ">
                            Retry
                        </button>
                    </div>
                `;

                    // Show upload section again
                    document.getElementById("uploadSection").style.display =
                        "block";
                }
            }

            async function processExcelData(data) {
                try {
                    const workbook = XLSX.read(data, { type: "array" });

                    const validSheets = workbook.SheetNames.filter((name) => {
                        if (name === "Sheet1") return false;
                        const worksheet = workbook.Sheets[name];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, {
                            header: 1,
                        });
                        return jsonData.length > 1;
                    });

                    if (validSheets.length === 0) {
                        throw new Error(
                            "No valid sheets found. The Excel file doesn't contain any data sheets (Sheet1 is ignored).",
                        );
                    }

                    validSheets.forEach((sheetName) => {
                        const worksheet = workbook.Sheets[sheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, {
                            header: 1,
                        });
                        workbookData[sheetName] = {
                            headers: jsonData[0] || [],
                            rows: jsonData
                                .slice(1)
                                .filter((row) =>
                                    row.some((cell) => cell != null),
                                ),
                        };
                    });

                    calculateGlobalMetrics();
                    renderDashboard(validSheets);

                    document
                        .getElementById("loading")
                        .classList.remove("active");
                    document
                        .getElementById("dashboard")
                        .classList.add("active");

                    // Show mobile menu button on mobile screens after data is loaded
                    if (
                        mobileMenuBtn &&
                        window.matchMedia("(max-width: 991px)").matches
                    ) {
                        mobileMenuBtn.style.display = "flex";
                    }

                    // Show download button after data loads
                    document.getElementById('downloadBtn').style.display = 'inline-block';
                } catch (error) {
                    console.error("Error processing Excel data:", error);
                    throw error; // Re-throw for caller to handle
                }
            }

            function handleFile(e) {
                const file = e.target.files[0];
                if (file) processFile(file);
            }

            async function processFile(file) {
                document.getElementById("uploadSection").style.display = "none";
                document.getElementById("loading").classList.add("active");

                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        await processExcelData(data);
                    } catch (error) {
                        console.error("Error processing file:", error);

                        // Show error in loading screen
                        const loadingEl = document.getElementById("loading");
                        loadingEl.innerHTML = `
                        <div style="text-align: center; padding: 40px;">
                            <div style="font-size: 48px; color: #ef4444; margin-bottom: 20px;">⚠️</div>
                            <h2 style="color: #ef4444; margin-bottom: 16px;">Error processing file</h2>
                            <p style="color: #94a3b8; margin-bottom: 8px;"><strong>Error:</strong> ${error.message}</p>
                            <p style="color: #94a3b8; font-size: 14px; margin-bottom: 24px;">
                                Please try uploading a different file or check the file format.
                            </p>
                            <button onclick="location.reload()" style="
                                background: #000000;
                                color: white;
                                border: none;
                                padding: 10px 20px;
                                border-radius: 8px;
                                cursor: pointer;
                                font-weight: 600;
                            ">
                                Try Again
                            </button>
                        </div>
                    `;
                    }
                };
                reader.readAsArrayBuffer(file);
            }

            function calculateGlobalMetrics() {
                // Calculate key metrics from all data
                let totalRevenue = 0;
                let uniqueClients = new Set();
                let totalServices = 0;

                // Get from Daily Summary if exists
                const dailySummary = Object.keys(workbookData).find((k) =>
                    k.toLowerCase().includes("daily summary"),
                );
                if (dailySummary) {
                    const data = workbookData[dailySummary];
                    const revenueCol = findColumnIndex(data.headers, [
                        "revenue",
                        "total revenue",
                    ]);
                    const servicesCol = findColumnIndex(data.headers, [
                        "services",
                        "total services",
                    ]);

                    if (revenueCol !== -1) {
                        totalRevenue = data.rows.reduce(
                            (sum, row) =>
                                sum + (parseFloat(row[revenueCol]) || 0),
                            0,
                        );
                    }
                    if (servicesCol !== -1) {
                        totalServices = data.rows.reduce(
                            (sum, row) =>
                                sum + (parseFloat(row[servicesCol]) || 0),
                            0,
                        );
                    }
                }

                // Get unique clients from Client Analysis
                const clientAnalysis = Object.keys(workbookData).find((k) =>
                    k.toLowerCase().includes("client analysis"),
                );
                if (clientAnalysis) {
                    uniqueClients = new Set(
                        workbookData[clientAnalysis].rows.map((r) => r[0]),
                    );
                }

                // Get forecast from Revenue Forecast
                let nextMonthForecast = 0;
                const forecast = Object.keys(workbookData).find((k) =>
                    k.toLowerCase().includes("forecast"),
                );
                if (forecast) {
                    const data = workbookData[forecast];
                    let actualHeaders = data.headers;
                    let actualRows = data.rows;

                    const hasValidHeaders = data.headers.some(
                        (h) =>
                            h &&
                            h
                                .toString()
                                .toLowerCase()
                                .includes("forecast month"),
                    );

                    if (!hasValidHeaders) {
                        for (
                            let i = 0;
                            i < Math.min(5, data.rows.length);
                            i++
                        ) {
                            const row = data.rows[i];
                            const hasForecastMonth = row.some(
                                (cell) =>
                                    cell &&
                                    cell
                                        .toString()
                                        .toLowerCase()
                                        .includes("forecast month"),
                            );
                            if (hasForecastMonth) {
                                actualHeaders = row;
                                actualRows = data.rows.slice(i + 1);
                                break;
                            }
                        }
                    }

                    const moderateCol = findColumnIndex(actualHeaders, [
                        "moderate",
                    ]);
                    if (moderateCol !== -1 && actualRows.length > 0) {
                        nextMonthForecast =
                            parseFloat(actualRows[0][moderateCol]) || 0;
                    }
                }

                // Get monthly data for additional metrics
                const monthlySummary = Object.keys(workbookData).find((k) =>
                    k.toLowerCase().includes("monthly summary")
                );
                
                let currentMonthRevenue = 0;
                let previousMonthRevenue = 0;
                let bestMonthRevenue = 0;
                let bestMonthName = '-';
                let avgMonthlyRevenue = 0;
                let totalMonths = 0;
                
                if (monthlySummary) {
                    const data = workbookData[monthlySummary];
                    // Find rows with "TOTAL" in the month column
                    const monthlyTotals = data.rows.filter(row => {
                        const monthValue = row[0]?.toString() || '';
                        return monthValue.includes('TOTAL');
                    });
                    
                    if (monthlyTotals.length > 0) {
                        totalMonths = monthlyTotals.length;
                        const revenueCol = findColumnIndex(data.headers, ['revenue']);
                        
                        if (revenueCol !== -1) {
                            // Current month (last entry)
                            currentMonthRevenue = parseFloat(monthlyTotals[monthlyTotals.length - 1][revenueCol]) || 0;
                            
                            // Previous month (second to last)
                            if (monthlyTotals.length > 1) {
                                previousMonthRevenue = parseFloat(monthlyTotals[monthlyTotals.length - 2][revenueCol]) || 0;
                            }
                            
                            // Find best month
                            let bestIdx = 0;
                            bestMonthRevenue = parseFloat(monthlyTotals[0][revenueCol]) || 0;
                            for (let i = 1; i < monthlyTotals.length; i++) {
                                const rev = parseFloat(monthlyTotals[i][revenueCol]) || 0;
                                if (rev > bestMonthRevenue) {
                                    bestMonthRevenue = rev;
                                    bestIdx = i;
                                }
                            }
                            bestMonthName = monthlyTotals[bestIdx][0]?.toString().replace(' TOTAL', '') || '-';
                            
                            // Calculate average monthly revenue
                            const totalMonthlyRevenue = monthlyTotals.reduce((sum, row) => 
                                sum + (parseFloat(row[revenueCol]) || 0), 0
                            );
                            avgMonthlyRevenue = totalMonthlyRevenue / monthlyTotals.length;
                        }
                    }
                }

                globalMetrics = {
                    totalRevenue,
                    uniqueClients: uniqueClients.size,
                    totalServices,
                    nextMonthForecast,
                    currentMonthRevenue,
                    previousMonthRevenue,
                    bestMonthRevenue,
                    bestMonthName,
                    avgMonthlyRevenue,
                    totalMonths
                };

                // UPDATE GLOBAL METRICS DISPLAY
                document.getElementById("global-revenue").textContent =
                    formatCurrency(totalRevenue);
                    
                document.getElementById("global-current-month").textContent =
                    formatCurrency(currentMonthRevenue);
                    
                // Calculate and display month-over-month trend
                if (previousMonthRevenue > 0) {
                    const growth = ((currentMonthRevenue - previousMonthRevenue) / previousMonthRevenue) * 100;
                    const trendEl = document.getElementById("global-month-trend");
                    trendEl.textContent = `${growth >= 0 ? '+' : ''}${growth.toFixed(1)}% vs last month`;
                    trendEl.className = `metric-trend ${growth >= 0 ? 'positive' : 'negative'}`;
                }
                
                document.getElementById("global-clients").textContent =
                    uniqueClients.size;
                    
                document.getElementById("global-services").textContent =
                    totalServices.toLocaleString();
                    
                document.getElementById("global-avg").textContent =
                    formatCurrency(totalRevenue / uniqueClients.size);
                    
                document.getElementById("global-best-month").textContent =
                    formatCurrency(bestMonthRevenue);
                document.getElementById("global-best-month-name").textContent =
                    bestMonthName;
                    
                document.getElementById("global-avg-monthly").textContent =
                    formatCurrency(avgMonthlyRevenue);
                document.getElementById("global-months-count").textContent =
                    `Over ${totalMonths} months`;
                    
                document.getElementById("global-forecast").textContent =
                    formatCurrency(nextMonthForecast);
            }

            function renderDashboard(sheetNames) {
                const tabsContainer = document.getElementById("tabs");
                const contentContainer = document.getElementById("tabsContent");

                tabsContainer.innerHTML = "";
                contentContainer.innerHTML = "";

                sheetNames.forEach((sheetName, index) => {
                    const tab = document.createElement("div");
                    tab.className = `tab ${index === 0 ? "active" : ""}`;
                    tab.textContent = sheetName;
                    tab.onclick = () => switchTab(index);
                    tabsContainer.appendChild(tab);

                    const content = document.createElement("div");
                    content.className = `tab-content ${index === 0 ? "active" : ""}`;
                    content.id = `content-${index}`;
                    contentContainer.appendChild(content);

                    renderSheetContent(sheetName, index);
                });
            }

            function switchTab(index) {
                document.querySelectorAll(".tab").forEach((tab, i) => {
                    tab.classList.toggle("active", i === index);
                });
                document
                    .querySelectorAll(".tab-content")
                    .forEach((content, i) => {
                        content.classList.toggle("active", i === index);
                    });
            }

            function renderSheetContent(sheetName, index) {
                const container = document.getElementById(`content-${index}`);
                const data = workbookData[sheetName];
                const nameLower = sheetName.toLowerCase();

                let html = "";
                let chartCount = 0;

                // Render metrics and charts based on sheet type
                if (nameLower.includes("monthly summary")) {
                    html = renderMonthlySummary(data, index);
                    chartCount = 3;
                } else if (nameLower.includes("daily summary")) {
                    html = renderDailySummary(data, index);
                    chartCount = 2;
                } else if (nameLower.includes("client analysis")) {
                    html = renderClientAnalysis(data, index);
                    chartCount = 3;
                } else if (nameLower.includes("service analysis")) {
                    html = renderServiceAnalysis(data, index);
                    chartCount = 3;
                } else if (nameLower.includes("forecast")) {
                    html = renderForecast(data, index);
                    chartCount = 1;
                } else {
                    html = renderGenericSheet(data, index);
                    chartCount = 1;
                }

                // Add table
                html += renderDataTable(data, index);

                container.innerHTML = html;

                // Initialize charts
                setTimeout(() => initializeCharts(sheetName, data, index), 100);
            }

            function renderMonthlySummary(data, index) {
                const monthCol = findColumnIndex(data.headers, [
                    "month",
                    "yearmonth",
                ]);
                const revenueCol = findColumnIndex(data.headers, [
                    "revenue",
                    "monthly revenue",
                ]);

                if (monthCol === -1 || revenueCol === -1) return "";

                return `
                <div class="charts-grid cols-3">
                    <div class="chart-card">
                        <div class="chart-title">Monthly Revenue Trend</div>
                        <div class="chart-subtitle">Revenue over time</div>
                        <div class="chart-container tall">
                            <canvas id="chart-${index}-0"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <div class="chart-title">Revenue Distribution</div>
                        <div class="chart-subtitle">Monthly breakdown</div>
                        <div class="chart-container">
                            <canvas id="chart-${index}-1"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <div class="chart-title">Growth Rate</div>
                        <div class="chart-subtitle">Month-over-month</div>
                        <div class="chart-container">
                            <canvas id="chart-${index}-2"></canvas>
                        </div>
                    </div>
                </div>
            `;
            }

            function renderDailySummary(data, index) {
                return `
                <div class="charts-grid cols-2">
                    <div class="chart-card">
                        <div class="chart-title">Daily Revenue</div>
                        <div class="chart-subtitle">Last 30 days</div>
                        <div class="chart-container tall">
                            <canvas id="chart-${index}-0"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <div class="chart-title">Services Volume</div>
                        <div class="chart-subtitle">Daily count</div>
                        <div class="chart-container tall">
                            <canvas id="chart-${index}-1"></canvas>
                        </div>
                    </div>
                </div>
            `;
            }

            function renderClientAnalysis(data, index) {
                return `
                <div class="charts-grid cols-3">
                    <div class="chart-card">
                        <div class="chart-title">Top 20 Clients</div>
                        <div class="chart-subtitle">By revenue</div>
                        <div class="chart-container tall">
                            <canvas id="chart-${index}-0"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <div class="chart-title">Client Tiers</div>
                        <div class="chart-subtitle">Distribution</div>
                        <div class="chart-container">
                            <canvas id="chart-${index}-1"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <div class="chart-title">Revenue Concentration</div>
                        <div class="chart-subtitle">Top 10 vs Others</div>
                        <div class="chart-container">
                            <canvas id="chart-${index}-2"></canvas>
                        </div>
                    </div>
                </div>
            `;
            }

            function renderServiceAnalysis(data, index) {
                return `
                <div class="charts-grid cols-3">
                    <div class="chart-card">
                        <div class="chart-title">Revenue by Service</div>
                        <div class="chart-subtitle">All services ranked</div>
                        <div class="chart-container tall">
                            <canvas id="chart-${index}-0"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <div class="chart-title">Top 10 Services</div>
                        <div class="chart-subtitle">Revenue distribution</div>
                        <div class="chart-container">
                            <canvas id="chart-${index}-1"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <div class="chart-title">Service Contribution</div>
                        <div class="chart-subtitle">Percentage breakdown</div>
                        <div class="chart-container">
                            <canvas id="chart-${index}-2"></canvas>
                        </div>
                    </div>
                </div>
            `;
            }

            function renderForecast(data, index) {
                return `
                <div class="charts-grid cols-1">
                    <div class="chart-card">
                        <div class="chart-title">Revenue Forecast</div>
                        <div class="chart-subtitle">3 scenarios for next 3 months</div>
                        <div class="chart-container tall">
                            <canvas id="chart-${index}-0"></canvas>
                        </div>
                    </div>
                </div>
            `;
            }

            function renderGenericSheet(data, index) {
                return `
                <div class="charts-grid cols-1">
                    <div class="chart-card">
                        <div class="chart-title">Data Overview</div>
                        <div class="chart-subtitle">First numeric column</div>
                        <div class="chart-container">
                            <canvas id="chart-${index}-0"></canvas>
                        </div>
                    </div>
                </div>
            `;
            }

            function renderDataTable(data, index) {
                return `
                <div class="table-section">
                    <div class="table-header">
                        <div class="table-title">Complete Data</div>
                        <div class="table-subtitle">${data.rows.length} rows × ${data.headers.length} columns</div>
                    </div>
                    <input type="text" class="search-box" id="search-${index}" placeholder="Search all columns..."
                           onkeyup="filterTableGlobal(${index}, this.value)">
                    <div class="table-wrapper">
                        <table id="table-${index}">
                            <thead>
                                <tr>
                                    ${data.headers.map((h, i) => `
                                        <th data-column="${i}">
                                            <div class="header-content">
                                                <span class="column-name" onclick="sortTable(${index}, ${i})">${h || "Column"}</span>
                                                <input type="text" 
                                                       class="column-filter" 
                                                       placeholder="Filter..." 
                                                       onkeyup="filterByColumn(${index})"
                                                       onclick="event.stopPropagation()">
                                            </div>
                                        </th>
                                    `).join("")}
                                </tr>
                            </thead>
                            <tbody id="tbody-${index}">
                                ${data.rows
                                    .map(
                                        (row) => `
                                    <tr>
                                        ${data.headers.map((_, i) => `<td>${formatCellValue(row[i])}</td>`).join("")}
                                    </tr>
                                `,
                                    )
                                    .join("")}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            }

            function initializeCharts(sheetName, data, index) {
                const nameLower = sheetName.toLowerCase();

                if (nameLower.includes("monthly summary")) {
                    createMonthlyCharts(data, index);
                } else if (nameLower.includes("daily summary")) {
                    createDailyCharts(data, index);
                } else if (nameLower.includes("client analysis")) {
                    createClientCharts(data, index);
                } else if (nameLower.includes("service analysis")) {
                    createServiceCharts(data, index);
                } else if (nameLower.includes("forecast")) {
                    createForecastCharts(data, index);
                } else {
                    createGenericChart(data, index);
                }
            }

            function createMonthlyCharts(data, index) {
                const monthCol = findColumnIndex(data.headers, [
                    "month",
                    "yearmonth",
                ]);
                const revenueCol = findColumnIndex(data.headers, [
                    "revenue",
                    "monthly revenue",
                ]);

                if (monthCol === -1 || revenueCol === -1) return;

                const months = data.rows.map((row) => row[monthCol]);
                const revenues = data.rows.map(
                    (row) => parseFloat(row[revenueCol]) || 0,
                );

                // Chart 1: Line
                const ctx1 = document
                    .getElementById(`chart-${index}-0`)
                    .getContext("2d");
                charts[`${index}-0`] = new Chart(ctx1, {
                    type: "line",
                    data: {
                        labels: months,
                        datasets: [
                            {
                                label: "Revenue",
                                data: revenues,
                                borderColor: "#000000",
                                backgroundColor: "rgba(0, 0, 0, 0.05)",
                                borderWidth: 2,
                                fill: true,
                                tension: 0.4,
                            },
                        ],
                    },
                    options: getChartOptions(),
                });

                // Chart 2: Bar
                const ctx2 = document
                    .getElementById(`chart-${index}-1`)
                    .getContext("2d");
                charts[`${index}-1`] = new Chart(ctx2, {
                    type: "bar",
                    data: {
                        labels: months,
                        datasets: [
                            {
                                label: "Revenue",
                                data: revenues,
                                backgroundColor: "#000000",
                            },
                        ],
                    },
                    options: getChartOptions(),
                });

                // Chart 3: Growth
                const growthRates = revenues.map((rev, i) => {
                    if (i === 0) return 0;
                    return ((rev - revenues[i - 1]) / revenues[i - 1]) * 100;
                });

                const ctx3 = document
                    .getElementById(`chart-${index}-2`)
                    .getContext("2d");
                charts[`${index}-2`] = new Chart(ctx3, {
                    type: "bar",
                    data: {
                        labels: months,
                        datasets: [
                            {
                                label: "Growth %",
                                data: growthRates,
                                backgroundColor: growthRates.map((r) =>
                                    r >= 0 ? "#059669" : "#dc2626",
                                ),
                            },
                        ],
                    },
                    options: getChartOptions(),
                });
            }

            function createDailyCharts(data, index) {
                const dateCol = findColumnIndex(data.headers, ["date"]);
                const revenueCol = findColumnIndex(data.headers, [
                    "revenue",
                    "total revenue",
                ]);
                const servicesCol = findColumnIndex(data.headers, [
                    "services",
                    "total services",
                ]);

                const last30 = data.rows.slice(-30);
                const dates = last30.map((row) => formatDate(row[dateCol]));
                const revenues = last30.map(
                    (row) => parseFloat(row[revenueCol]) || 0,
                );
                const services = last30.map(
                    (row) => parseFloat(row[servicesCol]) || 0,
                );

                const ctx1 = document
                    .getElementById(`chart-${index}-0`)
                    .getContext("2d");
                charts[`${index}-0`] = new Chart(ctx1, {
                    type: "line",
                    data: {
                        labels: dates,
                        datasets: [
                            {
                                label: "Revenue",
                                data: revenues,
                                borderColor: "#000000",
                                backgroundColor: "rgba(0, 0, 0, 0.05)",
                                borderWidth: 2,
                                fill: true,
                                tension: 0.4,
                            },
                        ],
                    },
                    options: getChartOptions(),
                });

                const ctx2 = document
                    .getElementById(`chart-${index}-1`)
                    .getContext("2d");
                charts[`${index}-1`] = new Chart(ctx2, {
                    type: "bar",
                    data: {
                        labels: dates,
                        datasets: [
                            {
                                label: "Services",
                                data: services,
                                backgroundColor: "#374151",
                            },
                        ],
                    },
                    options: getChartOptions(),
                });
            }

            function createClientCharts(data, index) {
                const clientCol = findColumnIndex(data.headers, ["client"]);
                const spentCol = findColumnIndex(data.headers, [
                    "spent",
                    "total spent",
                ]);
                const tierCol = findColumnIndex(data.headers, [
                    "tier",
                    "client tier",
                ]);

                const top20 = data.rows.slice(0, 20);
                const clients = top20.map((row) => row[clientCol]);
                const spent = top20.map(
                    (row) => parseFloat(row[spentCol]) || 0,
                );

                const ctx1 = document
                    .getElementById(`chart-${index}-0`)
                    .getContext("2d");
                charts[`${index}-0`] = new Chart(ctx1, {
                    type: "bar",
                    data: {
                        labels: clients,
                        datasets: [
                            {
                                label: "Revenue",
                                data: spent,
                                backgroundColor: "#000000",
                            },
                        ],
                    },
                    options: {
                        ...getChartOptions(),
                        indexAxis: "y",
                    },
                });

                if (tierCol !== -1) {
                    const tiers = {};
                    data.rows.forEach((row) => {
                        const tier = row[tierCol];
                        tiers[tier] = (tiers[tier] || 0) + 1;
                    });

                    const ctx2 = document
                        .getElementById(`chart-${index}-1`)
                        .getContext("2d");
                    charts[`${index}-1`] = new Chart(ctx2, {
                        type: "doughnut",
                        data: {
                            labels: Object.keys(tiers),
                            datasets: [
                                {
                                    data: Object.values(tiers),
                                    backgroundColor: [
                                        "#3b82f6",
                                        "#8b5cf6",
                                        "#10b981",
                                        "#f59e0b",
                                    ],
                                },
                            ],
                        },
                        options: getDoughnutOptions(),
                    });

                    // Update mobile tabs visibility
                    updateTabsForScreenSize();
                }

                const top10Revenue = data.rows
                    .slice(0, 10)
                    .reduce(
                        (sum, row) => sum + (parseFloat(row[spentCol]) || 0),
                        0,
                    );
                const totalRevenue = data.rows.reduce(
                    (sum, row) => sum + (parseFloat(row[spentCol]) || 0),
                    0,
                );

                const ctx3 = document
                    .getElementById(`chart-${index}-2`)
                    .getContext("2d");
                charts[`${index}-2`] = new Chart(ctx3, {
                    type: "doughnut",
                    data: {
                        labels: ["Top 10", "Others"],
                        datasets: [
                            {
                                data: [
                                    top10Revenue,
                                    totalRevenue - top10Revenue,
                                ],
                                backgroundColor: ["#000000", "#9ca3af"],
                            },
                        ],
                    },
                    options: getDoughnutOptions(),
                });
            }

            function createServiceCharts(data, index) {
                const serviceCol = findColumnIndex(data.headers, ["service"]);
                const revenueCol = findColumnIndex(data.headers, [
                    "revenue",
                    "total revenue",
                ]);

                const sortedData = [...data.rows].sort(
                    (a, b) =>
                        (parseFloat(b[revenueCol]) || 0) -
                        (parseFloat(a[revenueCol]) || 0),
                );

                const services = sortedData.map((row) => row[serviceCol]);
                const revenues = sortedData.map(
                    (row) => parseFloat(row[revenueCol]) || 0,
                );

                const ctx1 = document
                    .getElementById(`chart-${index}-0`)
                    .getContext("2d");
                charts[`${index}-0`] = new Chart(ctx1, {
                    type: "bar",
                    data: {
                        labels: services,
                        datasets: [
                            {
                                label: "Revenue",
                                data: revenues,
                                backgroundColor: "#000000",
                            },
                        ],
                    },
                    options: {
                        ...getChartOptions(),
                        indexAxis: "y",
                    },
                });

                const ctx2 = document
                    .getElementById(`chart-${index}-1`)
                    .getContext("2d");
                charts[`${index}-1`] = new Chart(ctx2, {
                    type: "doughnut",
                    data: {
                        labels: services.slice(0, 10),
                        datasets: [
                            {
                                data: revenues.slice(0, 10),
                                backgroundColor: [
                                    "#000000",
                                    "#1f2937",
                                    "#374151",
                                    "#f59e0b",
                                    "#ef4444",
                                    "#06b6d4",
                                    "#ec4899",
                                    "#6366f1",
                                    "#14b8a6",
                                    "#f97316",
                                ],
                            },
                        ],
                    },
                    options: getDoughnutOptions(),
                });

                const totalRevenue = revenues.reduce((a, b) => a + b, 0);
                const percentages = revenues.map(
                    (r) => (r / totalRevenue) * 100,
                );

                const ctx3 = document
                    .getElementById(`chart-${index}-2`)
                    .getContext("2d");
                charts[`${index}-2`] = new Chart(ctx3, {
                    type: "bar",
                    data: {
                        labels: services,
                        datasets: [
                            {
                                label: "Contribution %",
                                data: percentages,
                                backgroundColor: "#374151",
                            },
                        ],
                    },
                    options: {
                        ...getChartOptions(),
                        indexAxis: "y",
                    },
                });
            }

            function createForecastCharts(data, index) {
                let actualHeaders = data.headers;
                let actualRows = data.rows;

                const hasValidHeaders = data.headers.some(
                    (h) =>
                        h &&
                        h.toString().toLowerCase().includes("forecast month"),
                );

                if (!hasValidHeaders) {
                    for (let i = 0; i < Math.min(5, data.rows.length); i++) {
                        const row = data.rows[i];
                        const hasForecastMonth = row.some(
                            (cell) =>
                                cell &&
                                cell
                                    .toString()
                                    .toLowerCase()
                                    .includes("forecast month"),
                        );
                        if (hasForecastMonth) {
                            actualHeaders = row;
                            actualRows = data.rows.slice(i + 1);
                            break;
                        }
                    }
                }

                const monthCol = findColumnIndex(actualHeaders, [
                    "month",
                    "forecast month",
                ]);
                const conservativeCol = findColumnIndex(actualHeaders, [
                    "conservative",
                ]);
                const moderateCol = findColumnIndex(actualHeaders, [
                    "moderate",
                ]);
                const optimisticCol = findColumnIndex(actualHeaders, [
                    "optimistic",
                ]);

                if (monthCol === -1 || conservativeCol === -1) return;

                const forecastRows = actualRows.filter((row) => {
                    const monthValue = row[monthCol];
                    return (
                        monthValue && monthValue.toString().match(/\d{4}-\d{2}/)
                    );
                });

                const months = forecastRows.map((row) => {
                    const monthVal = row[monthCol];
                    if (
                        typeof monthVal === "string" &&
                        monthVal.match(/\d{4}-\d{2}/)
                    ) {
                        const [year, month] = monthVal.split("-");
                        const monthNames = [
                            "Jan",
                            "Feb",
                            "Mar",
                            "Apr",
                            "May",
                            "Jun",
                            "Jul",
                            "Aug",
                            "Sep",
                            "Oct",
                            "Nov",
                            "Dec",
                        ];
                        return monthNames[parseInt(month) - 1] + " " + year;
                    }
                    return monthVal.toString();
                });

                const conservative = forecastRows.map(
                    (row) => parseFloat(row[conservativeCol]) || 0,
                );
                const moderate = forecastRows.map(
                    (row) => parseFloat(row[moderateCol]) || 0,
                );
                const optimistic = forecastRows.map(
                    (row) => parseFloat(row[optimisticCol]) || 0,
                );

                const ctx = document
                    .getElementById(`chart-${index}-0`)
                    .getContext("2d");
                charts[`${index}-0`] = new Chart(ctx, {
                    type: "line",
                    data: {
                        labels: months,
                        datasets: [
                            {
                                label: "Conservative",
                                data: conservative,
                                borderColor: "#ef4444",
                                backgroundColor: "rgba(239, 68, 68, 0.1)",
                                borderWidth: 2,
                                fill: true,
                                tension: 0.4,
                            },
                            {
                                label: "Moderate",
                                data: moderate,
                                borderColor: "#000000",
                                backgroundColor: "rgba(0, 0, 0, 0.05)",
                                borderWidth: 2,
                                fill: true,
                                tension: 0.4,
                            },
                            {
                                label: "Optimistic",
                                data: optimistic,
                                borderColor: "#10b981",
                                backgroundColor: "rgba(16, 185, 129, 0.1)",
                                borderWidth: 2,
                                fill: true,
                                tension: 0.4,
                            },
                        ],
                    },
                    options: getChartOptions(),
                });
            }

            function createGenericChart(data, index) {
                const numericCols = findNumericColumns(data);
                if (numericCols.length === 0) return;

                const col = numericCols[0];
                const values = data.rows
                    .map((row) => parseFloat(row[col]) || 0)
                    .slice(0, 20);
                const labels = data.rows
                    .map((row, i) => row[0] || `Row ${i + 1}`)
                    .slice(0, 20);

                const ctx = document
                    .getElementById(`chart-${index}-0`)
                    .getContext("2d");
                charts[`${index}-0`] = new Chart(ctx, {
                    type: "bar",
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: data.headers[col] || "Value",
                                data: values,
                                backgroundColor: "#000000",
                            },
                        ],
                    },
                    options: getChartOptions(),
                });
            }

            function getChartOptions() {
                const isMobile = window.matchMedia("(max-width: 767px)").matches;
                
                return {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: isMobile ? 'nearest' : 'index',
                        intersect: false,
                        axis: 'x'
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: "#111827",
                                font: { 
                                    size: isMobile ? 12 : 13,
                                    weight: '600'
                                },
                                padding: isMobile ? 10 : 12,
                            },
                        },
                        tooltip: {
                            enabled: true,
                            backgroundColor: '#000000',
                            padding: isMobile ? 16 : 14,
                            titleFont: {
                                size: isMobile ? 15 : 14,
                                weight: '700'
                            },
                            bodyFont: {
                                size: isMobile ? 14 : 13,
                                weight: '500'
                            },
                            bodySpacing: 8,
                            boxPadding: 6,
                            usePointStyle: true,
                            cornerRadius: 8,
                            displayColors: true,
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += formatCurrency(context.parsed.y);
                                    }
                                    return label;
                                }
                            }
                        },
                    },
                    elements: {
                        point: {
                            radius: isMobile ? 0 : 3,
                            hoverRadius: isMobile ? 8 : 5,
                            hitRadius: isMobile ? 30 : 10,
                        },
                        line: {
                            borderWidth: isMobile ? 2.5 : 2,
                        }
                    },
                    scales: {
                        x: {
                            grid: { 
                                color: "rgba(0, 0, 0, 0.06)",
                                display: !isMobile
                            },
                            ticks: { 
                                color: "#6b7280", 
                                maxRotation: isMobile ? 90 : 45,
                                minRotation: isMobile ? 45 : 0,
                                font: {
                                    size: isMobile ? 10 : 11,
                                    weight: '500'
                                },
                                autoSkip: true,
                                maxTicksLimit: isMobile ? 8 : 15
                            },
                        },
                        y: {
                            grid: { 
                                color: "rgba(0, 0, 0, 0.08)"
                            },
                            ticks: { 
                                color: "#6b7280",
                                font: {
                                    size: isMobile ? 11 : 11,
                                    weight: '500'
                                },
                                callback: function(value) {
                                    if (value >= 1000) {
                                        return (value / 1000).toFixed(0) + 'k';
                                    }
                                    return value;
                                }
                            },
                        },
                    },
                };
            }

            function getDoughnutOptions() {
                const isMobile = window.matchMedia("(max-width: 767px)").matches;
                
                return {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'point',
                    },
                    plugins: {
                        legend: {
                            position: isMobile ? "bottom" : "right",
                            labels: {
                                color: "#111827",
                                font: { 
                                    size: isMobile ? 11 : 12,
                                    weight: '600'
                                },
                                padding: isMobile ? 12 : 10,
                                boxWidth: isMobile ? 15 : 12,
                            },
                        },
                        tooltip: {
                            enabled: true,
                            backgroundColor: '#000000',
                            padding: isMobile ? 16 : 14,
                            titleFont: {
                                size: isMobile ? 15 : 14,
                                weight: '700'
                            },
                            bodyFont: {
                                size: isMobile ? 14 : 13,
                                weight: '500'
                            },
                            cornerRadius: 8,
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    const value = context.parsed;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    label += formatCurrency(value) + ' (' + percentage + '%)';
                                    return label;
                                }
                            }
                        },
                    },
                    elements: {
                        arc: {
                            borderWidth: isMobile ? 3 : 2,
                            hoverBorderWidth: isMobile ? 5 : 3,
                        }
                    }
                };
            }

            function findColumnIndex(headers, keywords) {
                for (let keyword of keywords) {
                    const index = headers.findIndex(
                        (h) =>
                            h &&
                            h
                                .toString()
                                .toLowerCase()
                                .includes(keyword.toLowerCase()),
                    );
                    if (index !== -1) return index;
                }
                return -1;
            }

            function findNumericColumns(data) {
                const numeric = [];
                for (let i = 0; i < data.headers.length; i++) {
                    const sample = data.rows.slice(0, 5).map((row) => row[i]);
                    if (
                        sample.some((v) => v !== null && !isNaN(parseFloat(v)))
                    ) {
                        numeric.push(i);
                    }
                }
                return numeric;
            }

            function formatCurrency(value) {
                if (!value && value !== 0) return "-";
                return new Intl.NumberFormat("ro-RO", {
                    style: "currency",
                    currency: "RON",
                    maximumFractionDigits: 0,
                }).format(value);
            }

            function formatDate(date) {
                if (!date) return "";
                if (typeof date === "number" && date > 40000 && date < 50000) {
                    const d = new Date((date - 25569) * 86400 * 1000);
                    return d.toLocaleDateString("en-GB", {
                        month: "short",
                        day: "numeric",
                    });
                }
                const d = new Date(date);
                if (isNaN(d)) return date;
                return d.toLocaleDateString("en-GB", {
                    month: "short",
                    day: "numeric",
                });
            }

            function formatCellValue(value) {
                if (value === null || value === undefined) return "";
                if (
                    typeof value === "number" &&
                    value > 40000 &&
                    value < 50000
                ) {
                    return formatDate(value);
                }
                if (typeof value === "number") {
                    return value.toLocaleString("ro-RO", {
                        maximumFractionDigits: 2,
                    });
                }
                return value.toString();
            }

            // Global search across all columns
            function filterTableGlobal(index, searchTerm) {
                // Clear all column filters first
                const table = document.getElementById(`table-${index}`);
                const columnFilters = table.querySelectorAll('.column-filter');
                columnFilters.forEach(input => input.value = '');
                
                // Apply global filter
                const rows = table.getElementsByTagName("tbody")[0].getElementsByTagName("tr");
                const term = searchTerm.toLowerCase();

                for (let row of rows) {
                    const text = row.textContent.toLowerCase();
                    row.style.display = text.includes(term) ? "" : "none";
                }
            }
            
            // Filter by individual columns
            function filterByColumn(index) {
                const table = document.getElementById(`table-${index}`);
                const rows = table.getElementsByTagName("tbody")[0].getElementsByTagName("tr");
                const headers = table.querySelectorAll("th");
                
                // Get all column filter values
                const columnFilters = [];
                headers.forEach((header, colIndex) => {
                    const input = header.querySelector('.column-filter');
                    if (input) {
                        columnFilters[colIndex] = input.value.toLowerCase();
                    }
                });
                
                // Clear global search
                const globalSearch = document.getElementById(`search-${index}`);
                if (globalSearch) globalSearch.value = '';
                
                // Filter rows
                for (let row of rows) {
                    let show = true;
                    const cells = row.getElementsByTagName("td");
                    
                    // Check each column filter
                    columnFilters.forEach((filterValue, colIndex) => {
                        if (filterValue && cells[colIndex]) {
                            const cellText = cells[colIndex].textContent.toLowerCase();
                            if (!cellText.includes(filterValue)) {
                                show = false;
                            }
                        }
                    });
                    
                    row.style.display = show ? "" : "none";
                }
            }
            
            // Store sort state for each table
            const tableSortState = {};
            
            function sortTable(index, columnIndex) {
                const table = document.getElementById(`table-${index}`);
                const tbody = document.getElementById(`tbody-${index}`);
                const rows = Array.from(tbody.getElementsByTagName("tr"));
                const headers = table.querySelectorAll("th");
                const columnNames = table.querySelectorAll(".column-name");
                
                // Initialize sort state for this table if needed
                if (!tableSortState[index]) {
                    tableSortState[index] = {};
                }
                
                // Determine sort direction
                const currentSort = tableSortState[index][columnIndex] || 'none';
                let newSort = 'asc';
                if (currentSort === 'asc') newSort = 'desc';
                else if (currentSort === 'desc') newSort = 'none';
                
                // Clear all sort indicators
                columnNames.forEach(cn => {
                    cn.classList.remove('sort-asc', 'sort-desc');
                });
                
                // Reset all columns except current
                Object.keys(tableSortState[index]).forEach(key => {
                    if (key != columnIndex) {
                        tableSortState[index][key] = 'none';
                    }
                });
                
                tableSortState[index][columnIndex] = newSort;
                
                if (newSort === 'none') {
                    // Restore original order - just return
                    return;
                }
                
                // Add sort indicator to the column name span
                columnNames[columnIndex].classList.add(newSort === 'asc' ? 'sort-asc' : 'sort-desc');
                
                // Get only visible rows (respecting filters)
                const visibleRows = rows.filter(row => row.style.display !== 'none');
                const hiddenRows = rows.filter(row => row.style.display === 'none');
                
                // Sort visible rows
                visibleRows.sort((a, b) => {
                    const aValue = a.getElementsByTagName("td")[columnIndex]?.textContent || '';
                    const bValue = b.getElementsByTagName("td")[columnIndex]?.textContent || '';
                    
                    // Try to parse as number
                    const aNum = parseFloat(aValue.replace(/[^\d.-]/g, ''));
                    const bNum = parseFloat(bValue.replace(/[^\d.-]/g, ''));
                    
                    let comparison = 0;
                    if (!isNaN(aNum) && !isNaN(bNum)) {
                        // Numeric comparison
                        comparison = aNum - bNum;
                    } else {
                        // String comparison
                        comparison = aValue.localeCompare(bValue);
                    }
                    
                    return newSort === 'asc' ? comparison : -comparison;
                });
                
                // Clear tbody
                tbody.innerHTML = '';
                
                // Re-append sorted visible rows, then hidden rows
                visibleRows.forEach(row => tbody.appendChild(row));
                hiddenRows.forEach(row => tbody.appendChild(row));
            }
        </script>
    </body>
</html>
