<!doctype html>
<!--
    Revenue Dashboard v2 - Modern Dark Theme

    FEATURES:
    - Modern dark theme with clean design
    - Mobile-first responsive layout (5 breakpoints)
    - Touch-optimized mobile interface
    - Mobile menu button for tabs on smaller screens
    - GitHub auto-load functionality
    - Excel file upload/drag-and-drop
    - Interactive charts with Chart.js
    - Global metrics dashboard
    - Smart chart grid layouts

    SETUP INSTRUCTIONS:
    1. Create a GitHub repository for your revenue dashboard
    2. Upload this index2.html file to the repo
    3. Upload your revenue_analysis_current.xlsx file to the repo
    4. Enable GitHub Pages in repository settings (Settings > Pages > Source: main branch)
    5. Update the EXCEL_FILE_URL constant in this file (line ~740) with your GitHub raw file URL
       Format: https://raw.githubusercontent.com/YOUR_USERNAME/YOUR_REPO/main/revenue_analysis_current.xlsx
    6. Every time you run your analysis script, commit and push the new Excel file to GitHub
    7. The dashboard will automatically fetch and display the latest data when loaded

    Your dashboard URL will be: https://YOUR_USERNAME.github.io/YOUR_REPO/

    LOCAL TESTING:
    - For local testing, run a simple HTTP server in this directory:
      - Python 3: python -m http.server 8000
      - Node.js: npx serve .
      - PHP: php -S localhost:8000
    - Then open http://localhost:8000/index2.html in your browser
    - The default EXCEL_FILE_URL points to 'revenue_analysis_current.xlsx' in the same directory

    MOBILE MENU:
    - On screens 991px and below, a "Tabs" menu button appears in the header
    - Click the button to show/hide the sheet tabs
    - Tabs are displayed as a vertical dropdown list on mobile
    - Menu automatically closes when selecting a tab or clicking outside
-->
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Revenue Dashboard</title>

        <!-- SheetJS -->
        <script src="https://cdn.sheetjs.com/xlsx-0.18.5/package/dist/xlsx.full.min.js"></script>

        <!-- Chart.js -->
        <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.js"></script>

        <!-- Inter font -->
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
            rel="stylesheet"
        />

        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            :root {
                --bg: #0f1419;
                --card-bg: #1a1f2e;
                --border: #2d3748;
                --text: #ffffff;
                --text-muted: #94a3b8;
                --blue: #3b82f6;
            }

            body {
                font-family: "Inter", sans-serif;
                background: var(--bg);
                color: var(--text);
                line-height: 1.5;
            }

            .container {
                max-width: 1920px;
                margin: 0 auto;
                padding: 24px;
            }

            /* Header */
            .header {
                margin-bottom: 32px;
            }

            .header-top {
                display: flex;
                justify-content: space-between;
                align-items: center;
                gap: 16px;
            }

            .header-title {
                flex: 1;
            }

            .header h1 {
                font-size: 28px;
                font-weight: 700;
                color: var(--text);
                margin-bottom: 4px;
            }

            .header p {
                font-size: 14px;
                color: var(--text-muted);
            }

            /* Mobile Menu Button */
            .mobile-menu-btn {
                display: none; /* Hidden by default */
                background: var(--card-bg);
                border: 1px solid var(--border);
                border-radius: 8px;
                color: var(--text);
                padding: 10px 16px;
                font-size: 14px;
                font-weight: 500;
                cursor: pointer;
                touch-action: manipulation;
                -webkit-tap-highlight-color: rgba(0, 0, 0, 0.1);
                user-select: none;
                min-height: 44px;
                align-items: center;
                gap: 8px;
                transition: all 0.2s;
            }

            .mobile-menu-btn:hover {
                border-color: var(--blue);
            }

            .mobile-menu-btn.active {
                background: var(--blue);
                border-color: var(--blue);
            }

            .menu-icon {
                display: inline-block;
                width: 18px;
                height: 2px;
                background: var(--text);
                position: relative;
            }

            .menu-icon::before,
            .menu-icon::after {
                content: "";
                position: absolute;
                width: 18px;
                height: 2px;
                background: var(--text);
                left: 0;
            }

            .menu-icon::before {
                top: -6px;
            }

            .menu-icon::after {
                bottom: -6px;
            }

            .mobile-menu-btn.active .menu-icon {
                background: transparent;
            }

            .mobile-menu-btn.active .menu-icon::before {
                transform: rotate(45deg);
                top: 0;
            }

            .mobile-menu-btn.active .menu-icon::after {
                transform: rotate(-45deg);
                bottom: 0;
            }

            /* Upload */
            .upload-section {
                background: var(--card-bg);
                border: 2px dashed var(--border);
                border-radius: 12px;
                padding: 48px;
                text-align: center;
                cursor: pointer;
                transition: all 0.2s;
                touch-action: manipulation; /* Faster tap response */
                -webkit-tap-highlight-color: rgba(
                    0,
                    0,
                    0,
                    0.1
                ); /* Better touch feedback */
                user-select: none; /* Prevent text selection on tap */
            }

            .upload-section:hover {
                border-color: var(--blue);
            }

            .upload-section h2 {
                font-size: 18px;
                font-weight: 600;
                margin-bottom: 8px;
            }

            .upload-section p {
                color: var(--text-muted);
                margin-bottom: 16px;
            }

            .btn-upload {
                background: var(--blue);
                color: white;
                border: none;
                padding: 10px 24px;
                border-radius: 8px;
                font-size: 14px;
                font-weight: 600;
                cursor: pointer;
                touch-action: manipulation; /* Faster tap response */
                -webkit-tap-highlight-color: rgba(
                    0,
                    0,
                    0,
                    0.1
                ); /* Better touch feedback */
                user-select: none; /* Prevent text selection on tap */
            }

            #fileInput {
                display: none;
            }

            /* Loading */
            .loading {
                text-align: center;
                padding: 60px;
                display: none;
            }

            .loading.active {
                display: block;
            }

            .spinner {
                width: 48px;
                height: 48px;
                margin: 0 auto 20px;
                border: 3px solid var(--border);
                border-top: 3px solid var(--blue);
                border-radius: 50%;
                animation: spin 1s linear infinite;
            }

            @keyframes spin {
                0% {
                    transform: rotate(0deg);
                }
                100% {
                    transform: rotate(360deg);
                }
            }

            /* Dashboard */
            .dashboard {
                display: none;
            }

            .dashboard.active {
                display: block;
            }

            /* GLOBAL METRICS - ABOVE TABS */
            .global-metrics {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 16px;
                margin-bottom: 24px;
            }

            /* Tabs - NO SCROLL, wrap to multiple lines */
            .tabs {
                display: flex;
                gap: 8px;
                margin-bottom: 24px;
                flex-wrap: wrap;
            }

            .tab {
                background: var(--card-bg);
                border: 1px solid var(--border);
                padding: 10px 20px;
                border-radius: 8px;
                cursor: pointer;
                transition: all 0.2s;
                font-size: 14px;
                font-weight: 500;
                white-space: nowrap;
                touch-action: manipulation; /* Faster tap response */
                -webkit-tap-highlight-color: rgba(
                    0,
                    0,
                    0,
                    0.1
                ); /* Better touch feedback */
                user-select: none; /* Prevent text selection on tap */
            }

            .tab:hover {
                border-color: var(--blue);
            }

            .tab.active {
                background: var(--blue);
                border-color: var(--blue);
                color: white;
            }

            /* Mobile tabs state */
            .tabs.tabs-mobile-hidden {
                display: none !important;
            }

            .tabs.tabs-mobile-visible {
                display: block !important;
                position: fixed !important;
                z-index: 10000 !important;
                background: var(--card-bg) !important;
                border: 1px solid var(--border) !important;
                border-radius: 8px !important;
                padding: 12px !important;
                max-height: 80vh !important;
                height: auto !important;
                overflow-y: scroll !important;
                overflow-x: hidden !important;
                -webkit-overflow-scrolling: touch !important;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4) !important;
                min-width: 250px !important;
                max-width: calc(100vw - 40px) !important;
            }
            
            .tabs.tabs-mobile-visible .tab {
                display: block !important;
                width: 100% !important;
                margin-bottom: 8px !important;
                text-align: left !important;
                padding: 14px 16px !important;
                white-space: normal !important;
            }
            
            /* Make scrollbar visible on mobile dropdown */
            .tabs.tabs-mobile-visible::-webkit-scrollbar {
                width: 8px;
            }
            
            .tabs.tabs-mobile-visible::-webkit-scrollbar-track {
                background: rgba(0, 0, 0, 0.2);
                border-radius: 4px;
            }
            
            .tabs.tabs-mobile-visible::-webkit-scrollbar-thumb {
                background: var(--blue);
                border-radius: 4px;
            }
            
            .tabs.tabs-mobile-visible::-webkit-scrollbar-thumb:hover {
                background: #2563eb;
            }

            /* Desktop tabs - always visible */
            .tabs.tabs-desktop-visible {
                display: flex !important;
            }

            /* Tab content */
            .tab-content {
                display: none;
            }

            .tab-content.active {
                display: block;
            }

            /* Key metrics cards at top */
            .metrics-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 16px;
                margin-bottom: 24px;
            }

            .metric-card {
                background: var(--card-bg);
                border: 1px solid var(--border);
                border-radius: 12px;
                padding: 20px;
            }

            .metric-label {
                font-size: 12px;
                font-weight: 500;
                color: var(--text-muted);
                text-transform: uppercase;
                letter-spacing: 0.5px;
                margin-bottom: 8px;
            }

            .metric-value {
                font-size: 28px;
                font-weight: 700;
                color: var(--text);
            }

            /* Charts - smart grid layout */
            .charts-grid {
                display: grid;
                gap: 20px;
                margin-bottom: 24px;
            }

            /* 1 chart = full width */
            .charts-grid.cols-1 {
                grid-template-columns: 1fr;
            }

            /* 2 charts = 50/50 */
            .charts-grid.cols-2 {
                grid-template-columns: repeat(2, 1fr);
            }

            /* 3 charts = 1 full width, 2 half */
            .charts-grid.cols-3 {
                grid-template-columns: repeat(2, 1fr);
            }

            .charts-grid.cols-3 .chart-card:first-child {
                grid-column: 1 / -1;
            }

            /* 4 charts = 2x2 grid */
            .charts-grid.cols-4 {
                grid-template-columns: repeat(2, 1fr);
            }

            /* 5 charts = 1 full, 2 half, 2 half */
            .charts-grid.cols-5 {
                grid-template-columns: repeat(2, 1fr);
            }

            .charts-grid.cols-5 .chart-card:first-child {
                grid-column: 1 / -1;
            }

            .chart-card {
                background: var(--card-bg);
                border: 1px solid var(--border);
                border-radius: 12px;
                padding: 20px;
            }

            .chart-title {
                font-size: 16px;
                font-weight: 600;
                margin-bottom: 4px;
            }

            .chart-subtitle {
                font-size: 13px;
                color: var(--text-muted);
                margin-bottom: 16px;
            }

            .chart-container {
                position: relative;
                height: 300px;
            }

            .chart-container.tall {
                height: 400px;
            }

            /* Table - scrollable container */
            .table-section {
                background: var(--card-bg);
                border: 1px solid var(--border);
                border-radius: 12px;
                padding: 20px;
            }

            .table-header {
                margin-bottom: 16px;
            }

            .table-title {
                font-size: 16px;
                font-weight: 600;
                margin-bottom: 4px;
            }

            .table-subtitle {
                font-size: 13px;
                color: var(--text-muted);
            }

            .search-box {
                width: 100%;
                max-width: 400px;
                background: var(--bg);
                border: 1px solid var(--border);
                border-radius: 8px;
                padding: 10px 14px;
                color: var(--text);
                font-size: 14px;
                margin-bottom: 16px;
            }

            .search-box:focus {
                outline: none;
                border-color: var(--blue);
            }

            /* SCROLLABLE TABLE CONTAINER */
            .table-wrapper {
                max-height: 600px;
                overflow: auto;
                border: 1px solid var(--border);
                border-radius: 8px;
            }

            table {
                width: 100%;
                border-collapse: collapse;
                font-size: 13px;
            }

            thead {
                position: sticky;
                top: 0;
                background: var(--bg);
                z-index: 10;
            }

            th {
                padding: 12px 16px;
                text-align: left;
                font-weight: 600;
                color: var(--text);
                border-bottom: 1px solid var(--border);
                white-space: nowrap;
            }

            td {
                padding: 10px 16px;
                border-bottom: 1px solid var(--border);
            }

            tbody tr:hover {
                background: rgba(59, 130, 246, 0.05);
            }

            /* Responsive - Mobile First Approach */

            /* Base mobile styles (applies to all screens) */
            .container {
                padding: 16px;
            }

            /* Small tablets and large phones (768px and up) */
            @media (min-width: 768px) {
                .container {
                    padding: 20px;
                }
            }

            /* Large tablets and small desktops (992px and up) */
            @media (min-width: 992px) {
                .container {
                    padding: 24px;
                }
            }

            /* Desktop (1200px and up) */
            @media (min-width: 1200px) {
                .container {
                    padding: 24px;
                }
            }

            /* Mobile-specific adjustments */
            @media (max-width: 1199px) {
                /* Tablet and below */
            }

            @media (max-width: 991px) {
                /* Small tablet and large phone */
                .charts-grid.cols-2,
                .charts-grid.cols-3,
                .charts-grid.cols-4,
                .charts-grid.cols-5 {
                    grid-template-columns: 1fr !important;
                }

                .charts-grid .chart-card {
                    grid-column: 1 !important;
                }

                .global-metrics {
                    grid-template-columns: repeat(2, 1fr);
                }

                /* Show mobile menu button on mobile screens */
                .mobile-menu-btn {
                    display: flex;
                }

                /* Tabs mobile - REMOVE THIS ENTIRE SECTION - handled by main CSS */

                .tabs.tabs-mobile-visible .tab {
                    width: 100%;
                    text-align: left;
                    padding: 12px 16px;
                    min-height: 44px;
                    white-space: normal;
                    line-height: 1.4;
                    flex-shrink: 0;
                    touch-action: manipulation;
                }

                .metric-value {
                    font-size: 24px;
                }
            }

            @media (max-width: 767px) {
                /* Phones and small tablets */
                .header h1 {
                    font-size: 24px;
                }

                .header p {
                    font-size: 13px;
                }

                /* Mobile menu button visible on mobile screens */
                .mobile-menu-btn {
                    display: flex;
                }

                /* Tabs mobile - REMOVE THIS ENTIRE SECTION - handled by main CSS */

                .upload-section {
                    padding: 32px 20px;
                }

                .upload-section h2 {
                    font-size: 16px;
                }

                .upload-section p {
                    font-size: 14px;
                }

                .btn-upload {
                    padding: 12px 24px;
                    font-size: 15px;
                    min-height: 48px;
                    min-width: 140px;
                }

                .global-metrics {
                    grid-template-columns: 1fr;
                    gap: 12px;
                }

                .metrics-grid {
                    grid-template-columns: 1fr;
                    gap: 12px;
                }

                .metric-card {
                    padding: 16px;
                }

                .metric-label {
                    font-size: 11px;
                }

                .metric-value {
                    font-size: 22px;
                }

                /* Tabs handled by mobile menu - see styles above */

                .chart-card {
                    padding: 16px;
                }

                .chart-title {
                    font-size: 15px;
                }

                .chart-subtitle {
                    font-size: 12px;
                }

                .chart-container {
                    height: 250px;
                }

                .chart-container.tall {
                    height: 320px;
                }

                .table-section {
                    padding: 16px;
                }

                .table-title {
                    font-size: 15px;
                }

                .table-subtitle {
                    font-size: 12px;
                }

                .search-box {
                    padding: 12px 14px;
                    font-size: 16px; /* Prevent iOS zoom */
                    max-width: 100%;
                }

                .table-wrapper {
                    max-height: 400px;
                }

                table {
                    font-size: 12px;
                }

                th,
                td {
                    padding: 8px 12px;
                }

                .loading {
                    padding: 40px 20px;
                }

                .loading h2 {
                    font-size: 16px;
                }
            }

            @media (max-width: 575px) {
                /* Small phones */
                .header h1 {
                    font-size: 22px;
                }

                .header {
                    margin-bottom: 24px;
                }

                .upload-section {
                    padding: 24px 16px;
                }

                .tab {
                    flex: 1 0 100%;
                    max-width: 100%;
                    font-size: 13px;
                    padding: 12px 16px;
                }

                .chart-container {
                    height: 220px;
                }

                .chart-container.tall {
                    height: 280px;
                }

                .table-wrapper {
                    max-height: 350px;
                }

                th,
                td {
                    padding: 6px 10px;
                }

                .search-box {
                    font-size: 16px; /* Prevent iOS zoom */
                    padding: 10px 12px;
                    max-width: 100%;
                }
            }

            @media (max-width: 399px) {
                /* Very small phones */
                .container {
                    padding: 12px;
                }

                .header h1 {
                    font-size: 20px;
                }

                .metric-value {
                    font-size: 20px;
                }

                .chart-container {
                    height: 200px;
                }

                .chart-container.tall {
                    height: 250px;
                }

                .table-wrapper {
                    max-height: 300px;
                }
            }

            /* Special handling for very wide tables on mobile */
            @media (max-width: 767px) {
                .table-wrapper {
                    overflow-x: auto;
                    -webkit-overflow-scrolling: touch;
                }

                table {
                    min-width: 600px; /* Ensures table doesn't collapse too much */
                }

                th,
                td {
                    white-space: nowrap;
                }
            }

            /* Print styles */
            @media print {
                .upload-section,
                .tabs,
                .search-box,
                .btn-upload {
                    display: none !important;
                }

                .dashboard.active {
                    display: block !important;
                }

                .tab-content.active {
                    display: block !important;
                }

                .table-wrapper {
                    max-height: none;
                    overflow: visible;
                }

                table {
                    border-collapse: collapse;
                }

                th,
                td {
                    border: 1px solid #ddd;
                }
            }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="header">
                <div class="header-top">
                    <div class="header-title">
                        <h1>Revenue Dashboard</h1>
                        <p>Data analytics and insights</p>
                    </div>
                    <button
                        class="mobile-menu-btn"
                        id="mobileMenuBtn"
                        aria-label="Toggle tabs menu"
                        aria-expanded="false"
                    >
                        <span class="menu-icon"></span>
                        <span class="menu-text">Tabs</span>
                    </button>
                </div>
            </div>

            <!-- Upload -->
            <div class="upload-section" id="uploadSection">
                <h2>Upload Excel File</h2>
                <p>Drop file here or click to browse</p>
                <button
                    class="btn-upload"
                    onclick="document.getElementById('fileInput').click()"
                >
                    Choose File
                </button>
                <input type="file" id="fileInput" accept=".xlsx,.xls" />
            </div>

            <!-- Loading -->
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <h2>Processing data...</h2>
            </div>

            <!-- Dashboard -->
            <div class="dashboard" id="dashboard">
                <!-- GLOBAL METRICS - ALWAYS VISIBLE -->
                <div class="global-metrics">
                    <div class="metric-card">
                        <div class="metric-label">Total Clients</div>
                        <div class="metric-value" id="global-clients">-</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Total Revenue</div>
                        <div class="metric-value" id="global-revenue">-</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Avg per Client</div>
                        <div class="metric-value" id="global-avg">-</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Next Month Forecast</div>
                        <div class="metric-value" id="global-forecast">-</div>
                    </div>
                </div>

                <div class="tabs" id="tabs"></div>
                <div id="tabsContent"></div>
            </div>
        </div>

        <script>
            let workbookData = {};
            let charts = {};
            let globalMetrics = {};

            // Configuration: Update this URL to your GitHub raw file URL
            // For local development: 'revenue_analysis_current.xlsx'
            // For GitHub Pages: 'https://raw.githubusercontent.com/YOUR_USERNAME/YOUR_REPO/main/revenue_analysis_current.xlsx'
            const EXCEL_FILE_URL = "revenue_analysis_current.xlsx";

            const fileInput = document.getElementById("fileInput");
            const uploadSection = document.getElementById("uploadSection");

            fileInput.addEventListener("change", handleFile);

            uploadSection.addEventListener("dragover", (e) => {
                e.preventDefault();
            });

            uploadSection.addEventListener("drop", (e) => {
                e.preventDefault();
                const file = e.dataTransfer.files[0];
                if (file) processFile(file);
            });

            uploadSection.addEventListener("click", (e) => {
                if (e.target.tagName !== "BUTTON") {
                    fileInput.click();
                }
            });

            // Mobile menu button functionality
            const mobileMenuBtn = document.getElementById("mobileMenuBtn");
            const tabsContainer = document.getElementById("tabs");

            function updateTabsForScreenSize() {
                if (!tabsContainer) return;

                const isMobile =
                    window.matchMedia("(max-width: 991px)").matches;

                if (isMobile) {
                    // On mobile: ensure tabs are hidden by default unless menu is active
                    if (
                        !tabsContainer.classList.contains("tabs-mobile-visible")
                    ) {
                        tabsContainer.classList.add("tabs-mobile-hidden");
                        tabsContainer.classList.remove("tabs-desktop-visible");
                    }
                } else {
                    // On desktop: show tabs normally, remove mobile classes
                    tabsContainer.classList.remove(
                        "tabs-mobile-hidden",
                        "tabs-mobile-visible",
                    );
                    tabsContainer.classList.add("tabs-desktop-visible");
                    // Reset inline styles
                    tabsContainer.style.position = "";
                    tabsContainer.style.margin = "";
                    tabsContainer.style.top = "";
                    tabsContainer.style.left = "";
                    tabsContainer.style.width = "";
                    tabsContainer.style.maxHeight = "";
                    tabsContainer.style.zIndex = "";
                    if (mobileMenuBtn) {
                        mobileMenuBtn.classList.remove("active");
                        mobileMenuBtn.setAttribute("aria-expanded", "false");
                    }
                }
            }

            function positionMobileTabsDropdown() {
                if (!mobileMenuBtn || !tabsContainer) return;

                const isMobile =
                    window.matchMedia("(max-width: 991px)").matches;
                if (!isMobile) return;

                if (tabsContainer.classList.contains("tabs-mobile-visible")) {
                    const btnRect = mobileMenuBtn.getBoundingClientRect();
                    const viewportHeight = window.innerHeight;
                    const viewportWidth = window.innerWidth;

                    // Simple positioning - let CSS handle everything else
                    const top = btnRect.bottom + 8;
                    const left = 20;
                    const width = viewportWidth - 40;
                    
                    tabsContainer.style.top = top + "px";
                    tabsContainer.style.left = left + "px";  
                    tabsContainer.style.right = "20px";
                    
                    console.log("Dropdown opened");
                }
            }

            if (mobileMenuBtn && tabsContainer) {
                // Initial setup - hide button until data is loaded
                mobileMenuBtn.style.display = "none";
                updateTabsForScreenSize();

                // Update on resize
                window.addEventListener("resize", updateTabsForScreenSize);

                mobileMenuBtn.addEventListener("click", (e) => {
                    e.stopPropagation();
                    const isVisible = tabsContainer.classList.contains(
                        "tabs-mobile-visible",
                    );

                    if (isVisible) {
                        // Hide tabs
                        tabsContainer.classList.remove("tabs-mobile-visible");
                        tabsContainer.classList.add("tabs-mobile-hidden");
                        mobileMenuBtn.classList.remove("active");
                        mobileMenuBtn.setAttribute("aria-expanded", "false");
                        // Clear all inline styles
                        tabsContainer.removeAttribute("style");
                    } else {
                        // Show tabs
                        tabsContainer.classList.remove("tabs-mobile-hidden");
                        tabsContainer.classList.add("tabs-mobile-visible");
                        mobileMenuBtn.classList.add("active");
                        mobileMenuBtn.setAttribute("aria-expanded", "true");
                        // Position dropdown below button
                        positionMobileTabsDropdown();
                    }
                });

                // Reposition dropdown on resize and scroll when visible
                window.addEventListener("resize", () => {
                    if (
                        tabsContainer.classList.contains("tabs-mobile-visible")
                    ) {
                        positionMobileTabsDropdown();
                    }
                });

                window.addEventListener("scroll", () => {
                    if (
                        tabsContainer.classList.contains("tabs-mobile-visible")
                    ) {
                        positionMobileTabsDropdown();
                    }
                });

                // Close mobile menu when clicking outside
                document.addEventListener("click", (e) => {
                    if (
                        !tabsContainer.contains(e.target) &&
                        !mobileMenuBtn.contains(e.target)
                    ) {
                        tabsContainer.classList.remove("tabs-mobile-visible");
                        tabsContainer.classList.add("tabs-mobile-hidden");
                        mobileMenuBtn.classList.remove("active");
                        mobileMenuBtn.setAttribute("aria-expanded", "false");
                    }
                });

                // Close mobile menu when a tab is clicked
                tabsContainer.addEventListener("click", (e) => {
                    if (e.target.classList.contains("tab")) {
                        // Small delay to allow tab switch to complete
                        setTimeout(() => {
                            tabsContainer.classList.remove(
                                "tabs-mobile-visible",
                            );
                            tabsContainer.classList.add("tabs-mobile-hidden");
                            mobileMenuBtn.classList.remove("active");
                            mobileMenuBtn.setAttribute(
                                "aria-expanded",
                                "false",
                            );
                        }, 300);
                    }
                });
            }

            // Auto-load Excel file from URL on page load
            window.addEventListener("DOMContentLoaded", () => {
                loadExcelFromURL();
            });

            async function loadExcelFromURL() {
                try {
                    // Show loading state
                    document.getElementById("uploadSection").style.display =
                        "none";
                    document.getElementById("loading").classList.add("active");

                    const response = await fetch(EXCEL_FILE_URL);
                    if (!response.ok) {
                        throw new Error(
                            `HTTP error! status: ${response.status}`,
                        );
                    }

                    const data = await response.arrayBuffer();
                    await processExcelData(data);
                } catch (error) {
                    console.error("Error loading Excel file:", error);

                    // Determine error type for user-friendly message
                    let errorDetails;
                    if (error.message.includes("404")) {
                        errorDetails =
                            "File not found (404). Make sure revenue_analysis_current.xlsx is in the same directory or update EXCEL_FILE_URL.";
                    } else if (error.message.includes("Failed to fetch")) {
                        errorDetails =
                            "Network error. Check your internet connection or CORS settings.";
                    } else if (
                        error.message.includes("Unexpected end of JSON")
                    ) {
                        errorDetails =
                            "Invalid file format. The file might be corrupted or not a valid Excel file.";
                    } else {
                        errorDetails = error.message;
                    }

                    // Show error in loading screen
                    const loadingEl = document.getElementById("loading");
                    loadingEl.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <div style="font-size: 48px; color: #ef4444; margin-bottom: 20px;">⚠️</div>
                        <h2 style="color: #ef4444; margin-bottom: 16px;">Failed to load data</h2>
                        <p style="color: #94a3b8; margin-bottom: 8px;"><strong>Error:</strong> ${errorDetails}</p>
                        <p style="color: #94a3b8; font-size: 14px; margin-bottom: 8px;">
                            Attempted to load: <code>${EXCEL_FILE_URL}</code>
                        </p>
                        <p style="color: #94a3b8; font-size: 14px; margin-bottom: 24px;">
                            You can still upload a file manually using the upload area below.
                        </p>
                        <button onclick="location.reload()" style="
                            background: #3b82f6;
                            color: white;
                            border: none;
                            padding: 10px 20px;
                            border-radius: 8px;
                            cursor: pointer;
                            font-weight: 600;
                        ">
                            Retry
                        </button>
                    </div>
                `;

                    // Show upload section again
                    document.getElementById("uploadSection").style.display =
                        "block";
                }
            }

            async function processExcelData(data) {
                try {
                    const workbook = XLSX.read(data, { type: "array" });

                    const validSheets = workbook.SheetNames.filter((name) => {
                        if (name === "Sheet1") return false;
                        const worksheet = workbook.Sheets[name];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, {
                            header: 1,
                        });
                        return jsonData.length > 1;
                    });

                    if (validSheets.length === 0) {
                        throw new Error(
                            "No valid sheets found. The Excel file doesn't contain any data sheets (Sheet1 is ignored).",
                        );
                    }

                    validSheets.forEach((sheetName) => {
                        const worksheet = workbook.Sheets[sheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, {
                            header: 1,
                        });
                        workbookData[sheetName] = {
                            headers: jsonData[0] || [],
                            rows: jsonData
                                .slice(1)
                                .filter((row) =>
                                    row.some((cell) => cell != null),
                                ),
                        };
                    });

                    calculateGlobalMetrics();
                    renderDashboard(validSheets);

                    document
                        .getElementById("loading")
                        .classList.remove("active");
                    document
                        .getElementById("dashboard")
                        .classList.add("active");

                    // Show mobile menu button on mobile screens after data is loaded
                    if (
                        mobileMenuBtn &&
                        window.matchMedia("(max-width: 991px)").matches
                    ) {
                        mobileMenuBtn.style.display = "flex";
                    }
                } catch (error) {
                    console.error("Error processing Excel data:", error);
                    throw error; // Re-throw for caller to handle
                }
            }

            function handleFile(e) {
                const file = e.target.files[0];
                if (file) processFile(file);
            }

            async function processFile(file) {
                document.getElementById("uploadSection").style.display = "none";
                document.getElementById("loading").classList.add("active");

                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        await processExcelData(data);
                    } catch (error) {
                        console.error("Error processing file:", error);

                        // Show error in loading screen
                        const loadingEl = document.getElementById("loading");
                        loadingEl.innerHTML = `
                        <div style="text-align: center; padding: 40px;">
                            <div style="font-size: 48px; color: #ef4444; margin-bottom: 20px;">⚠️</div>
                            <h2 style="color: #ef4444; margin-bottom: 16px;">Error processing file</h2>
                            <p style="color: #94a3b8; margin-bottom: 8px;"><strong>Error:</strong> ${error.message}</p>
                            <p style="color: #94a3b8; font-size: 14px; margin-bottom: 24px;">
                                Please try uploading a different file or check the file format.
                            </p>
                            <button onclick="location.reload()" style="
                                background: #3b82f6;
                                color: white;
                                border: none;
                                padding: 10px 20px;
                                border-radius: 8px;
                                cursor: pointer;
                                font-weight: 600;
                            ">
                                Try Again
                            </button>
                        </div>
                    `;
                    }
                };
                reader.readAsArrayBuffer(file);
            }

            function calculateGlobalMetrics() {
                // Calculate key metrics from all data
                let totalRevenue = 0;
                let uniqueClients = new Set();
                let totalServices = 0;

                // Get from Daily Summary if exists
                const dailySummary = Object.keys(workbookData).find((k) =>
                    k.toLowerCase().includes("daily summary"),
                );
                if (dailySummary) {
                    const data = workbookData[dailySummary];
                    const revenueCol = findColumnIndex(data.headers, [
                        "revenue",
                        "total revenue",
                    ]);
                    const servicesCol = findColumnIndex(data.headers, [
                        "services",
                        "total services",
                    ]);

                    if (revenueCol !== -1) {
                        totalRevenue = data.rows.reduce(
                            (sum, row) =>
                                sum + (parseFloat(row[revenueCol]) || 0),
                            0,
                        );
                    }
                    if (servicesCol !== -1) {
                        totalServices = data.rows.reduce(
                            (sum, row) =>
                                sum + (parseFloat(row[servicesCol]) || 0),
                            0,
                        );
                    }
                }

                // Get unique clients from Client Analysis
                const clientAnalysis = Object.keys(workbookData).find((k) =>
                    k.toLowerCase().includes("client analysis"),
                );
                if (clientAnalysis) {
                    uniqueClients = new Set(
                        workbookData[clientAnalysis].rows.map((r) => r[0]),
                    );
                }

                // Get forecast from Revenue Forecast
                let nextMonthForecast = 0;
                const forecast = Object.keys(workbookData).find((k) =>
                    k.toLowerCase().includes("forecast"),
                );
                if (forecast) {
                    const data = workbookData[forecast];
                    let actualHeaders = data.headers;
                    let actualRows = data.rows;

                    const hasValidHeaders = data.headers.some(
                        (h) =>
                            h &&
                            h
                                .toString()
                                .toLowerCase()
                                .includes("forecast month"),
                    );

                    if (!hasValidHeaders) {
                        for (
                            let i = 0;
                            i < Math.min(5, data.rows.length);
                            i++
                        ) {
                            const row = data.rows[i];
                            const hasForecastMonth = row.some(
                                (cell) =>
                                    cell &&
                                    cell
                                        .toString()
                                        .toLowerCase()
                                        .includes("forecast month"),
                            );
                            if (hasForecastMonth) {
                                actualHeaders = row;
                                actualRows = data.rows.slice(i + 1);
                                break;
                            }
                        }
                    }

                    const moderateCol = findColumnIndex(actualHeaders, [
                        "moderate",
                    ]);
                    if (moderateCol !== -1 && actualRows.length > 0) {
                        nextMonthForecast =
                            parseFloat(actualRows[0][moderateCol]) || 0;
                    }
                }

                globalMetrics = {
                    totalRevenue,
                    uniqueClients: uniqueClients.size,
                    totalServices,
                    nextMonthForecast,
                };

                // UPDATE GLOBAL METRICS DISPLAY
                document.getElementById("global-clients").textContent =
                    uniqueClients.size;
                document.getElementById("global-revenue").textContent =
                    formatCurrency(totalRevenue);
                document.getElementById("global-avg").textContent =
                    formatCurrency(totalRevenue / uniqueClients.size);
                document.getElementById("global-forecast").textContent =
                    formatCurrency(nextMonthForecast);
            }

            function renderDashboard(sheetNames) {
                const tabsContainer = document.getElementById("tabs");
                const contentContainer = document.getElementById("tabsContent");

                tabsContainer.innerHTML = "";
                contentContainer.innerHTML = "";

                sheetNames.forEach((sheetName, index) => {
                    const tab = document.createElement("div");
                    tab.className = `tab ${index === 0 ? "active" : ""}`;
                    tab.textContent = sheetName;
                    tab.onclick = () => switchTab(index);
                    tabsContainer.appendChild(tab);

                    const content = document.createElement("div");
                    content.className = `tab-content ${index === 0 ? "active" : ""}`;
                    content.id = `content-${index}`;
                    contentContainer.appendChild(content);

                    renderSheetContent(sheetName, index);
                });
            }

            function switchTab(index) {
                document.querySelectorAll(".tab").forEach((tab, i) => {
                    tab.classList.toggle("active", i === index);
                });
                document
                    .querySelectorAll(".tab-content")
                    .forEach((content, i) => {
                        content.classList.toggle("active", i === index);
                    });
            }

            function renderSheetContent(sheetName, index) {
                const container = document.getElementById(`content-${index}`);
                const data = workbookData[sheetName];
                const nameLower = sheetName.toLowerCase();

                let html = "";
                let chartCount = 0;

                // Render metrics and charts based on sheet type
                if (nameLower.includes("monthly summary")) {
                    html = renderMonthlySummary(data, index);
                    chartCount = 3;
                } else if (nameLower.includes("daily summary")) {
                    html = renderDailySummary(data, index);
                    chartCount = 2;
                } else if (nameLower.includes("client analysis")) {
                    html = renderClientAnalysis(data, index);
                    chartCount = 3;
                } else if (nameLower.includes("service analysis")) {
                    html = renderServiceAnalysis(data, index);
                    chartCount = 3;
                } else if (nameLower.includes("forecast")) {
                    html = renderForecast(data, index);
                    chartCount = 1;
                } else {
                    html = renderGenericSheet(data, index);
                    chartCount = 1;
                }

                // Add table
                html += renderDataTable(data, index);

                container.innerHTML = html;

                // Initialize charts
                setTimeout(() => initializeCharts(sheetName, data, index), 100);
            }

            function renderMonthlySummary(data, index) {
                const monthCol = findColumnIndex(data.headers, [
                    "month",
                    "yearmonth",
                ]);
                const revenueCol = findColumnIndex(data.headers, [
                    "revenue",
                    "monthly revenue",
                ]);

                if (monthCol === -1 || revenueCol === -1) return "";

                return `
                <div class="charts-grid cols-3">
                    <div class="chart-card">
                        <div class="chart-title">Monthly Revenue Trend</div>
                        <div class="chart-subtitle">Revenue over time</div>
                        <div class="chart-container tall">
                            <canvas id="chart-${index}-0"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <div class="chart-title">Revenue Distribution</div>
                        <div class="chart-subtitle">Monthly breakdown</div>
                        <div class="chart-container">
                            <canvas id="chart-${index}-1"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <div class="chart-title">Growth Rate</div>
                        <div class="chart-subtitle">Month-over-month</div>
                        <div class="chart-container">
                            <canvas id="chart-${index}-2"></canvas>
                        </div>
                    </div>
                </div>
            `;
            }

            function renderDailySummary(data, index) {
                return `
                <div class="charts-grid cols-2">
                    <div class="chart-card">
                        <div class="chart-title">Daily Revenue</div>
                        <div class="chart-subtitle">Last 30 days</div>
                        <div class="chart-container tall">
                            <canvas id="chart-${index}-0"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <div class="chart-title">Services Volume</div>
                        <div class="chart-subtitle">Daily count</div>
                        <div class="chart-container tall">
                            <canvas id="chart-${index}-1"></canvas>
                        </div>
                    </div>
                </div>
            `;
            }

            function renderClientAnalysis(data, index) {
                return `
                <div class="charts-grid cols-3">
                    <div class="chart-card">
                        <div class="chart-title">Top 20 Clients</div>
                        <div class="chart-subtitle">By revenue</div>
                        <div class="chart-container tall">
                            <canvas id="chart-${index}-0"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <div class="chart-title">Client Tiers</div>
                        <div class="chart-subtitle">Distribution</div>
                        <div class="chart-container">
                            <canvas id="chart-${index}-1"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <div class="chart-title">Revenue Concentration</div>
                        <div class="chart-subtitle">Top 10 vs Others</div>
                        <div class="chart-container">
                            <canvas id="chart-${index}-2"></canvas>
                        </div>
                    </div>
                </div>
            `;
            }

            function renderServiceAnalysis(data, index) {
                return `
                <div class="charts-grid cols-3">
                    <div class="chart-card">
                        <div class="chart-title">Revenue by Service</div>
                        <div class="chart-subtitle">All services ranked</div>
                        <div class="chart-container tall">
                            <canvas id="chart-${index}-0"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <div class="chart-title">Top 10 Services</div>
                        <div class="chart-subtitle">Revenue distribution</div>
                        <div class="chart-container">
                            <canvas id="chart-${index}-1"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <div class="chart-title">Service Contribution</div>
                        <div class="chart-subtitle">Percentage breakdown</div>
                        <div class="chart-container">
                            <canvas id="chart-${index}-2"></canvas>
                        </div>
                    </div>
                </div>
            `;
            }

            function renderForecast(data, index) {
                return `
                <div class="charts-grid cols-1">
                    <div class="chart-card">
                        <div class="chart-title">Revenue Forecast</div>
                        <div class="chart-subtitle">3 scenarios for next 3 months</div>
                        <div class="chart-container tall">
                            <canvas id="chart-${index}-0"></canvas>
                        </div>
                    </div>
                </div>
            `;
            }

            function renderGenericSheet(data, index) {
                return `
                <div class="charts-grid cols-1">
                    <div class="chart-card">
                        <div class="chart-title">Data Overview</div>
                        <div class="chart-subtitle">First numeric column</div>
                        <div class="chart-container">
                            <canvas id="chart-${index}-0"></canvas>
                        </div>
                    </div>
                </div>
            `;
            }

            function renderDataTable(data, index) {
                return `
                <div class="table-section">
                    <div class="table-header">
                        <div class="table-title">Complete Data</div>
                        <div class="table-subtitle">${data.rows.length} rows × ${data.headers.length} columns</div>
                    </div>
                    <input type="text" class="search-box" placeholder="Search..."
                           onkeyup="filterTable(${index}, this.value)">
                    <div class="table-wrapper">
                        <table id="table-${index}">
                            <thead>
                                <tr>
                                    ${data.headers.map((h) => `<th>${h || "Column"}</th>`).join("")}
                                </tr>
                            </thead>
                            <tbody>
                                ${data.rows
                                    .map(
                                        (row) => `
                                    <tr>
                                        ${data.headers.map((_, i) => `<td>${formatCellValue(row[i])}</td>`).join("")}
                                    </tr>
                                `,
                                    )
                                    .join("")}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            }

            function initializeCharts(sheetName, data, index) {
                const nameLower = sheetName.toLowerCase();

                if (nameLower.includes("monthly summary")) {
                    createMonthlyCharts(data, index);
                } else if (nameLower.includes("daily summary")) {
                    createDailyCharts(data, index);
                } else if (nameLower.includes("client analysis")) {
                    createClientCharts(data, index);
                } else if (nameLower.includes("service analysis")) {
                    createServiceCharts(data, index);
                } else if (nameLower.includes("forecast")) {
                    createForecastCharts(data, index);
                } else {
                    createGenericChart(data, index);
                }
            }

            function createMonthlyCharts(data, index) {
                const monthCol = findColumnIndex(data.headers, [
                    "month",
                    "yearmonth",
                ]);
                const revenueCol = findColumnIndex(data.headers, [
                    "revenue",
                    "monthly revenue",
                ]);

                if (monthCol === -1 || revenueCol === -1) return;

                const months = data.rows.map((row) => row[monthCol]);
                const revenues = data.rows.map(
                    (row) => parseFloat(row[revenueCol]) || 0,
                );

                // Chart 1: Line
                const ctx1 = document
                    .getElementById(`chart-${index}-0`)
                    .getContext("2d");
                charts[`${index}-0`] = new Chart(ctx1, {
                    type: "line",
                    data: {
                        labels: months,
                        datasets: [
                            {
                                label: "Revenue",
                                data: revenues,
                                borderColor: "#3b82f6",
                                backgroundColor: "rgba(59, 130, 246, 0.1)",
                                borderWidth: 2,
                                fill: true,
                                tension: 0.4,
                            },
                        ],
                    },
                    options: getChartOptions(),
                });

                // Chart 2: Bar
                const ctx2 = document
                    .getElementById(`chart-${index}-1`)
                    .getContext("2d");
                charts[`${index}-1`] = new Chart(ctx2, {
                    type: "bar",
                    data: {
                        labels: months,
                        datasets: [
                            {
                                label: "Revenue",
                                data: revenues,
                                backgroundColor: "#3b82f6",
                            },
                        ],
                    },
                    options: getChartOptions(),
                });

                // Chart 3: Growth
                const growthRates = revenues.map((rev, i) => {
                    if (i === 0) return 0;
                    return ((rev - revenues[i - 1]) / revenues[i - 1]) * 100;
                });

                const ctx3 = document
                    .getElementById(`chart-${index}-2`)
                    .getContext("2d");
                charts[`${index}-2`] = new Chart(ctx3, {
                    type: "bar",
                    data: {
                        labels: months,
                        datasets: [
                            {
                                label: "Growth %",
                                data: growthRates,
                                backgroundColor: growthRates.map((r) =>
                                    r >= 0 ? "#10b981" : "#ef4444",
                                ),
                            },
                        ],
                    },
                    options: getChartOptions(),
                });
            }

            function createDailyCharts(data, index) {
                const dateCol = findColumnIndex(data.headers, ["date"]);
                const revenueCol = findColumnIndex(data.headers, [
                    "revenue",
                    "total revenue",
                ]);
                const servicesCol = findColumnIndex(data.headers, [
                    "services",
                    "total services",
                ]);

                const last30 = data.rows.slice(-30);
                const dates = last30.map((row) => formatDate(row[dateCol]));
                const revenues = last30.map(
                    (row) => parseFloat(row[revenueCol]) || 0,
                );
                const services = last30.map(
                    (row) => parseFloat(row[servicesCol]) || 0,
                );

                const ctx1 = document
                    .getElementById(`chart-${index}-0`)
                    .getContext("2d");
                charts[`${index}-0`] = new Chart(ctx1, {
                    type: "line",
                    data: {
                        labels: dates,
                        datasets: [
                            {
                                label: "Revenue",
                                data: revenues,
                                borderColor: "#3b82f6",
                                backgroundColor: "rgba(59, 130, 246, 0.1)",
                                borderWidth: 2,
                                fill: true,
                                tension: 0.4,
                            },
                        ],
                    },
                    options: getChartOptions(),
                });

                const ctx2 = document
                    .getElementById(`chart-${index}-1`)
                    .getContext("2d");
                charts[`${index}-1`] = new Chart(ctx2, {
                    type: "bar",
                    data: {
                        labels: dates,
                        datasets: [
                            {
                                label: "Services",
                                data: services,
                                backgroundColor: "#10b981",
                            },
                        ],
                    },
                    options: getChartOptions(),
                });
            }

            function createClientCharts(data, index) {
                const clientCol = findColumnIndex(data.headers, ["client"]);
                const spentCol = findColumnIndex(data.headers, [
                    "spent",
                    "total spent",
                ]);
                const tierCol = findColumnIndex(data.headers, [
                    "tier",
                    "client tier",
                ]);

                const top20 = data.rows.slice(0, 20);
                const clients = top20.map((row) => row[clientCol]);
                const spent = top20.map(
                    (row) => parseFloat(row[spentCol]) || 0,
                );

                const ctx1 = document
                    .getElementById(`chart-${index}-0`)
                    .getContext("2d");
                charts[`${index}-0`] = new Chart(ctx1, {
                    type: "bar",
                    data: {
                        labels: clients,
                        datasets: [
                            {
                                label: "Revenue",
                                data: spent,
                                backgroundColor: "#3b82f6",
                            },
                        ],
                    },
                    options: {
                        ...getChartOptions(),
                        indexAxis: "y",
                    },
                });

                if (tierCol !== -1) {
                    const tiers = {};
                    data.rows.forEach((row) => {
                        const tier = row[tierCol];
                        tiers[tier] = (tiers[tier] || 0) + 1;
                    });

                    const ctx2 = document
                        .getElementById(`chart-${index}-1`)
                        .getContext("2d");
                    charts[`${index}-1`] = new Chart(ctx2, {
                        type: "doughnut",
                        data: {
                            labels: Object.keys(tiers),
                            datasets: [
                                {
                                    data: Object.values(tiers),
                                    backgroundColor: [
                                        "#3b82f6",
                                        "#8b5cf6",
                                        "#10b981",
                                        "#f59e0b",
                                    ],
                                },
                            ],
                        },
                        options: getDoughnutOptions(),
                    });

                    // Update mobile tabs visibility
                    updateTabsForScreenSize();
                }

                const top10Revenue = data.rows
                    .slice(0, 10)
                    .reduce(
                        (sum, row) => sum + (parseFloat(row[spentCol]) || 0),
                        0,
                    );
                const totalRevenue = data.rows.reduce(
                    (sum, row) => sum + (parseFloat(row[spentCol]) || 0),
                    0,
                );

                const ctx3 = document
                    .getElementById(`chart-${index}-2`)
                    .getContext("2d");
                charts[`${index}-2`] = new Chart(ctx3, {
                    type: "doughnut",
                    data: {
                        labels: ["Top 10", "Others"],
                        datasets: [
                            {
                                data: [
                                    top10Revenue,
                                    totalRevenue - top10Revenue,
                                ],
                                backgroundColor: ["#3b82f6", "#64748b"],
                            },
                        ],
                    },
                    options: getDoughnutOptions(),
                });
            }

            function createServiceCharts(data, index) {
                const serviceCol = findColumnIndex(data.headers, ["service"]);
                const revenueCol = findColumnIndex(data.headers, [
                    "revenue",
                    "total revenue",
                ]);

                const sortedData = [...data.rows].sort(
                    (a, b) =>
                        (parseFloat(b[revenueCol]) || 0) -
                        (parseFloat(a[revenueCol]) || 0),
                );

                const services = sortedData.map((row) => row[serviceCol]);
                const revenues = sortedData.map(
                    (row) => parseFloat(row[revenueCol]) || 0,
                );

                const ctx1 = document
                    .getElementById(`chart-${index}-0`)
                    .getContext("2d");
                charts[`${index}-0`] = new Chart(ctx1, {
                    type: "bar",
                    data: {
                        labels: services,
                        datasets: [
                            {
                                label: "Revenue",
                                data: revenues,
                                backgroundColor: "#3b82f6",
                            },
                        ],
                    },
                    options: {
                        ...getChartOptions(),
                        indexAxis: "y",
                    },
                });

                const ctx2 = document
                    .getElementById(`chart-${index}-1`)
                    .getContext("2d");
                charts[`${index}-1`] = new Chart(ctx2, {
                    type: "doughnut",
                    data: {
                        labels: services.slice(0, 10),
                        datasets: [
                            {
                                data: revenues.slice(0, 10),
                                backgroundColor: [
                                    "#3b82f6",
                                    "#8b5cf6",
                                    "#10b981",
                                    "#f59e0b",
                                    "#ef4444",
                                    "#06b6d4",
                                    "#ec4899",
                                    "#6366f1",
                                    "#14b8a6",
                                    "#f97316",
                                ],
                            },
                        ],
                    },
                    options: getDoughnutOptions(),
                });

                const totalRevenue = revenues.reduce((a, b) => a + b, 0);
                const percentages = revenues.map(
                    (r) => (r / totalRevenue) * 100,
                );

                const ctx3 = document
                    .getElementById(`chart-${index}-2`)
                    .getContext("2d");
                charts[`${index}-2`] = new Chart(ctx3, {
                    type: "bar",
                    data: {
                        labels: services,
                        datasets: [
                            {
                                label: "Contribution %",
                                data: percentages,
                                backgroundColor: "#10b981",
                            },
                        ],
                    },
                    options: {
                        ...getChartOptions(),
                        indexAxis: "y",
                    },
                });
            }

            function createForecastCharts(data, index) {
                let actualHeaders = data.headers;
                let actualRows = data.rows;

                const hasValidHeaders = data.headers.some(
                    (h) =>
                        h &&
                        h.toString().toLowerCase().includes("forecast month"),
                );

                if (!hasValidHeaders) {
                    for (let i = 0; i < Math.min(5, data.rows.length); i++) {
                        const row = data.rows[i];
                        const hasForecastMonth = row.some(
                            (cell) =>
                                cell &&
                                cell
                                    .toString()
                                    .toLowerCase()
                                    .includes("forecast month"),
                        );
                        if (hasForecastMonth) {
                            actualHeaders = row;
                            actualRows = data.rows.slice(i + 1);
                            break;
                        }
                    }
                }

                const monthCol = findColumnIndex(actualHeaders, [
                    "month",
                    "forecast month",
                ]);
                const conservativeCol = findColumnIndex(actualHeaders, [
                    "conservative",
                ]);
                const moderateCol = findColumnIndex(actualHeaders, [
                    "moderate",
                ]);
                const optimisticCol = findColumnIndex(actualHeaders, [
                    "optimistic",
                ]);

                if (monthCol === -1 || conservativeCol === -1) return;

                const forecastRows = actualRows.filter((row) => {
                    const monthValue = row[monthCol];
                    return (
                        monthValue && monthValue.toString().match(/\d{4}-\d{2}/)
                    );
                });

                const months = forecastRows.map((row) => {
                    const monthVal = row[monthCol];
                    if (
                        typeof monthVal === "string" &&
                        monthVal.match(/\d{4}-\d{2}/)
                    ) {
                        const [year, month] = monthVal.split("-");
                        const monthNames = [
                            "Jan",
                            "Feb",
                            "Mar",
                            "Apr",
                            "May",
                            "Jun",
                            "Jul",
                            "Aug",
                            "Sep",
                            "Oct",
                            "Nov",
                            "Dec",
                        ];
                        return monthNames[parseInt(month) - 1] + " " + year;
                    }
                    return monthVal.toString();
                });

                const conservative = forecastRows.map(
                    (row) => parseFloat(row[conservativeCol]) || 0,
                );
                const moderate = forecastRows.map(
                    (row) => parseFloat(row[moderateCol]) || 0,
                );
                const optimistic = forecastRows.map(
                    (row) => parseFloat(row[optimisticCol]) || 0,
                );

                const ctx = document
                    .getElementById(`chart-${index}-0`)
                    .getContext("2d");
                charts[`${index}-0`] = new Chart(ctx, {
                    type: "line",
                    data: {
                        labels: months,
                        datasets: [
                            {
                                label: "Conservative",
                                data: conservative,
                                borderColor: "#ef4444",
                                backgroundColor: "rgba(239, 68, 68, 0.1)",
                                borderWidth: 2,
                                fill: true,
                                tension: 0.4,
                            },
                            {
                                label: "Moderate",
                                data: moderate,
                                borderColor: "#3b82f6",
                                backgroundColor: "rgba(59, 130, 246, 0.1)",
                                borderWidth: 2,
                                fill: true,
                                tension: 0.4,
                            },
                            {
                                label: "Optimistic",
                                data: optimistic,
                                borderColor: "#10b981",
                                backgroundColor: "rgba(16, 185, 129, 0.1)",
                                borderWidth: 2,
                                fill: true,
                                tension: 0.4,
                            },
                        ],
                    },
                    options: getChartOptions(),
                });
            }

            function createGenericChart(data, index) {
                const numericCols = findNumericColumns(data);
                if (numericCols.length === 0) return;

                const col = numericCols[0];
                const values = data.rows
                    .map((row) => parseFloat(row[col]) || 0)
                    .slice(0, 20);
                const labels = data.rows
                    .map((row, i) => row[0] || `Row ${i + 1}`)
                    .slice(0, 20);

                const ctx = document
                    .getElementById(`chart-${index}-0`)
                    .getContext("2d");
                charts[`${index}-0`] = new Chart(ctx, {
                    type: "bar",
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: data.headers[col] || "Value",
                                data: values,
                                backgroundColor: "#3b82f6",
                            },
                        ],
                    },
                    options: getChartOptions(),
                });
            }

            function getChartOptions() {
                return {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: "#ffffff",
                                font: { size: 12 },
                            },
                        },
                    },
                    scales: {
                        x: {
                            grid: { color: "rgba(255, 255, 255, 0.05)" },
                            ticks: { color: "#94a3b8", maxRotation: 45 },
                        },
                        y: {
                            grid: { color: "rgba(255, 255, 255, 0.05)" },
                            ticks: { color: "#94a3b8" },
                        },
                    },
                };
            }

            function getDoughnutOptions() {
                return {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: "right",
                            labels: {
                                color: "#ffffff",
                                font: { size: 11 },
                            },
                        },
                    },
                };
            }

            function findColumnIndex(headers, keywords) {
                for (let keyword of keywords) {
                    const index = headers.findIndex(
                        (h) =>
                            h &&
                            h
                                .toString()
                                .toLowerCase()
                                .includes(keyword.toLowerCase()),
                    );
                    if (index !== -1) return index;
                }
                return -1;
            }

            function findNumericColumns(data) {
                const numeric = [];
                for (let i = 0; i < data.headers.length; i++) {
                    const sample = data.rows.slice(0, 5).map((row) => row[i]);
                    if (
                        sample.some((v) => v !== null && !isNaN(parseFloat(v)))
                    ) {
                        numeric.push(i);
                    }
                }
                return numeric;
            }

            function formatCurrency(value) {
                if (!value && value !== 0) return "-";
                return new Intl.NumberFormat("ro-RO", {
                    style: "currency",
                    currency: "RON",
                    maximumFractionDigits: 0,
                }).format(value);
            }

            function formatDate(date) {
                if (!date) return "";
                if (typeof date === "number" && date > 40000 && date < 50000) {
                    const d = new Date((date - 25569) * 86400 * 1000);
                    return d.toLocaleDateString("en-GB", {
                        month: "short",
                        day: "numeric",
                    });
                }
                const d = new Date(date);
                if (isNaN(d)) return date;
                return d.toLocaleDateString("en-GB", {
                    month: "short",
                    day: "numeric",
                });
            }

            function formatCellValue(value) {
                if (value === null || value === undefined) return "";
                if (
                    typeof value === "number" &&
                    value > 40000 &&
                    value < 50000
                ) {
                    return formatDate(value);
                }
                if (typeof value === "number") {
                    return value.toLocaleString("ro-RO", {
                        maximumFractionDigits: 2,
                    });
                }
                return value.toString();
            }

            function filterTable(index, searchTerm) {
                const table = document.getElementById(`table-${index}`);
                const rows = table
                    .getElementsByTagName("tbody")[0]
                    .getElementsByTagName("tr");
                const term = searchTerm.toLowerCase();

                for (let row of rows) {
                    const text = row.textContent.toLowerCase();
                    row.style.display = text.includes(term) ? "" : "none";
                }
            }
        </script>
    </body>
</html>
